!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="5d7cf863-c92f-480d-be67-2a9dfadf4cdd",e._sentryDebugIdIdentifier="sentry-dbid-5d7cf863-c92f-480d-be67-2a9dfadf4cdd")}catch(e){}}();"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[20549],{1509:(e,t,s)=>{s.d(t,{M:()=>r});var o=s(5129);async function*n(e){if(null===e.body)throw Error("Cannot process response chunks of a response without body.");let t=e.body.getReader(),s=new TextDecoder,o="";for(;;){let{done:e,value:n}=await t.read();if(e)break;let[r,a]=i(o+=s.decode(n,{stream:!0}));for(let e of r)yield e;o=a}let[n,r]=i(o);for(let e of n)yield e;r.length>0&&(yield r)}function i(e){let t=e.split("\n"),s=t.pop();return[t,s]}async function*r(e){for await(let t of n(e))try{let s=JSON.parse(t);(0,o.YM)(s,e),yield s}catch(t){(0,o.YM)(t,e)}}},2376:(e,t,s)=>{s.d(t,{ru:()=>y,_c:()=>I,sS:()=>f,v5:()=>m});var o=s(28245),n=s(38541),i=s.n(n),r=s(88382),a=s(65146),d=s(6132),l=s(75500);let c=d.z.object({personaId:d.z.string(),prompt:d.z.string().optional()}),u=d.z.object({personaPresets:d.z.array(c)}),h=d.z.union([d.z.literal("imageGen"),d.z.literal("search"),d.z.literal("think"),d.z.literal("deepsearch")]),p=d.z.object({personaId:d.z.string(),name:d.z.string(),systemPromptName:d.z.string(),disclaimer:d.z.string().optional(),disabledTools:h.array(),prompt:d.z.string().optional()});function m(){let{stage:e}=(0,o.S)(),{t}=(0,a.Bd)("base"),s=function(){let e=(0,l.h)();return(0,r.useMemo)(()=>{var t;let s=null==(t=e.PERSONAS)?void 0:t.value;if(!s)return{personaPresets:[]};let o=u.safeParse(s);return o.success?o.data:{personaPresets:[]}},[e.PERSONAS])}(),n=(0,r.useMemo)(()=>({news:t("persona-name.news","Latest News"),romance:t("persona-name.romance","Companion"),unhinged:t("persona-name.unhinged","Unhinged Comedian"),friend:t("persona-name.friend","Loyal Friend"),tutor:t("persona-name.tutor","Homework Helper"),doctor:t("persona-name.doctor_with_quotes",'Grok "Doc"'),therapist:t("persona-name.therapist_with_quotes",'"Therapist"'),scientist:t("persona-name.scientist","Scientist"),coder:t("persona-name.coder","Coder")}),[t]),d=(0,r.useMemo)(()=>v.map(e=>({personaId:e,name:n[e],systemPromptName:g[e],disabledTools:[],prompt:function(e,t){let s=t.personaPresets.find(t=>t.personaId===e);return(null==s?void 0:s.prompt)||""}(e,s)})).filter(t=>!y.includes(t.personaId)||"nopass"!==e).map(e=>p.safeParse(e)).filter(e=>e.success).map(e=>e.data),[e,n,s]),c=(0,r.useMemo)(()=>i().keyBy(d,e=>e.personaId),[d]),h=(0,r.useCallback)(e=>{if(!v.includes(e))return;let t=c[e];if(t)return t},[c]),m=(0,r.useCallback)(e=>{if(!e||!e.personaId||!v.includes(e.personaId))return;let t=c[e.personaId];if(t)return t},[c]);return{personas:d,personaById:c,getPersonaForConversation:m,getPersonaFromId:h}}let v=["news","romance","unhinged","friend","tutor","doctor","therapist"],g={doctor:"grok3_personality_medical_advisor",news:"grok3_personality_latest_news",friend:"grok3_personality_loyal_friend",tutor:"grok3_personality_homework_helper",romance:"grok3_personality_romance_me",unhinged:"grok3_personality_unhinged_comedian",therapist:"grok3_personality_trusted_therapist",scientist:"grok3_personality_science_geek",coder:"grok3_personality_cracked_coder"};function I(e){if(!e)return;let t=i().invert(g)[e];if(f(t))return t}function f(e){return!!e&&v.includes(e)}let y=["romance","unhinged"]},4295:(e,t,s)=>{s.d(t,{c:()=>n,f:()=>i});var o=s(88382);function n(){let[e,t]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{let e=()=>{let e=navigator.userAgent||navigator.vendor;t(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(e))};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),e}function i(){let e=navigator.userAgent||navigator.vendor;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(e)}},5790:(e,t,s)=>{s.d(t,{iV:()=>c});var o=s(40764),n=s(4778),i=s(65258);let r=["home","account","team","appearance","chat","personality","data","billing","dev","behavior","billing","connected-apps"];var a=new WeakSet;class d{constructor(e,t){var s,d;if((0,n._)(this,a),this.set=e,this.get=t,this.open=!1,this.tab="home",this.expanded=!1,this.modelConfigOverrideTab=void 0,this.setOpen=e=>{this.set(t=>({...t,open:e})),(0,o._)(this,a,l).call(this,e)},this.toggleOpen=()=>{let e=!this.get().open;this.set(t=>({...t,open:e})),(0,o._)(this,a,l).call(this,e)},this.setTab=e=>{this.set({tab:e}),(0,o._)(this,a,l).call(this,this.get().open,e)},this.toggleExpanded=()=>{this.set(e=>({...e,expanded:!e.expanded}))},this.setModelConfigOverrideTab=(0,i.kp)(this.set,"modelConfigOverrideTab"),!(null==(d=globalThis)||null==(s=d.window)?void 0:s.location))return;let c=new URL(window.location.href).searchParams.get("_s");if(!function(e){return!!e&&r.includes(e)}(c))return;this.open=!0,this.tab=c}}function l(e,t){let s=new URL(window.location.href);e?s.searchParams.set("_s",null!=t?t:this.get().tab):s.searchParams.delete("_s"),window.history.replaceState({},"",s.toString())}let c=(0,i.y$)(d,"useSettingsDialogStore");(0,i.CP)(c,"expanded","settings-dialog-expanded",!1)},13103:(e,t,s)=>{s.d(t,{Cf:()=>u,Es:()=>p,L3:()=>m,ZJ:()=>l,c7:()=>h,eB:()=>i,lG:()=>a,rr:()=>v,zM:()=>d});var o=s(79342),n=s(61312),i=s(53592),r=s(88382);let a=i.bL,d=i.l9,l=i.ZL;i.bm;let c=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,o.jsx)(i.hJ,{ref:t,className:(0,n.cn)("fixed inset-0 bg-overlay backdrop-blur-[2px] duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...r})});c.displayName=i.hJ.displayName;let u=r.forwardRef((e,t)=>{let{className:s,overlayClassname:r,children:a,...d}=e;return(0,o.jsxs)(l,{children:[(0,o.jsx)(c,{className:r}),(0,o.jsx)(i.UC,{ref:t,className:(0,n.cn)("fixed left-[50%] top-[50%] grid translate-x-[-50%] translate-y-[-50%] gap-4 bg-surface-base dark:border dark:border-border-l1 duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",s),onCloseAutoFocus:e=>{e.preventDefault(),document.body.style.pointerEvents=""},...d,children:a})]})});u.displayName=i.UC.displayName;let h=e=>{let{className:t,...s}=e;return(0,o.jsx)("div",{className:(0,n.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...s})};h.displayName="DialogHeader";let p=e=>{let{className:t,...s}=e;return(0,o.jsx)("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s})};p.displayName="DialogFooter";let m=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,o.jsx)(i.hE,{ref:t,className:(0,n.cn)("text-lg font-semibold leading-none tracking-tight",s),...r})});m.displayName=i.hE.displayName;let v=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,o.jsx)(i.VY,{ref:t,className:(0,n.cn)("text-sm text-muted-foreground",s),...r})});v.displayName=i.VY.displayName},14455:(e,t,s)=>{function o(e){return t=>new Promise(s=>{setTimeout(()=>s(t),e)})}s.d(t,{N:()=>o})},24994:(e,t,s)=>{s.d(t,{R:()=>l});var o=s(79342);s(88382);var n=s(13103),i=s(34500),r=s(41320),a=s(61312),d=s(65146);function l(e){let{open:t,setOpen:s,trigger:l,title:c,description:u,footer:h,children:p,contentClassName:m,headerClassName:v,footerClassName:g,titleClassName:I,descriptionClassName:f,blurBackground:y}=e,{t:S}=(0,d.Bd)();return!(0,r.Di)()&&t?(0,o.jsxs)(n.lG,{open:t,onOpenChange:s,children:[l&&(0,o.jsx)(n.zM,{asChild:!0,children:l}),(0,o.jsxs)(n.Cf,{className:(0,a.cn)("focus:outline-none rounded-none",m),overlayClassname:(0,a.cn)(y&&"backdrop-blur-lg"),"aria-describedby":void 0,children:[(0,o.jsxs)(n.c7,{className:(0,a.cn)(!c&&!u&&"sr-only",v),children:[(0,o.jsx)(n.L3,{className:I,children:null!=c?c:S("dialog.title","Dialog")}),u?(0,o.jsx)(n.rr,{className:f,children:u}):null]}),p,h?(0,o.jsx)(n.Es,{className:g,children:h}):null]})]}):(0,o.jsxs)(i._s,{open:t,onOpenChange:s,dismissible:!!s,children:[l&&(0,o.jsx)(i.Uz,{asChild:!0,children:l}),(0,o.jsxs)(i.zj,{className:(0,a.cn)("focus:outline-none",m,"max-w-none !rounded-b-none"),overlayClassName:(0,a.cn)(y&&"backdrop-blur-lg"),"aria-describedby":void 0,children:[(0,o.jsxs)(i.BE,{className:(0,a.cn)(!c&&!u&&"sr-only","p-0 text-left",v),children:[(0,o.jsx)(i.gk,{className:I,children:null!=c?c:S("dialog.title","Dialog")}),u?(0,o.jsx)(i.I6,{className:f,children:u}):null]}),p,h?(0,o.jsx)(i.tb,{className:(0,a.cn)("pt-2",g),children:h}):null]})]})}},28245:(e,t,s)=>{s.d(t,{S:()=>g,T:()=>I});var o=s(79342),n=s(56691),i=s(24994),r=s(61312),a=s(23232),d=s(68332),l=s(44347),c=s(88382),u=s(65146),h=s(82509),p=s(17823),m=s(69648),v=s(42557);let g=(0,h.v)()((0,p.Zr)(e=>({stage:"start",setStage:t=>e({stage:t})}),{name:"age-verif"}));function I(e){let{onPass:t}=e,{t:s}=(0,u.Bd)("base"),{stage:h,setStage:p}=g(),{routeToConversation:I}=(0,d.o)(),{user:f}=(0,v.wV)(),y=(0,a._)(),S=(0,c.useCallback)(()=>{y("clicked_signin",void 0,{location:"age-verification"})},[y]),b=(0,c.useCallback)(()=>{p("pass"),null==t||t(),y("selected_over_18","pass",{location:"over-18-verification"})},[t,y,p]),C=(0,c.useCallback)(()=>{p("nopass"),y("selected_over_18","nopass",{location:"over-18-verification"})},[y,p]),R=(0,c.useCallback)(()=>{let{setShowAgeVerification:e}=l.C$.getState();e(!1),I(void 0)},[I]);return(0,o.jsxs)(i.R,{open:"pass"!==h,contentClassName:(0,r.cn)("focus:outline-0 focus-within:outline-0 gap-2","bg-background rounded-3xl","w-full md:w-5/6 lg:w-3/5 max-w-sm","flex flex-col","md:overflow-hidden","px-6 py-6"),blurBackground:!0,headerClassName:(0,r.cn)("nopass"===h&&"mb-4"),titleClassName:(0,r.cn)("nopass"===h&&"mb-1"),title:"nopass"===h?s("Restricted","Restricted"):"start"===h?s("Please confirm your age","Please confirm your age"):null,description:"nopass"===h?s("Restricted.description","Based on the information you provided you cannot use Grok image generation or 18+ personas."):"start"===h?s("Please confirm your age.description","In order to continue using Grok we need to confirm your age."):null,children:["start"===h&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"flex items-center justify-center gap-4 p-1",children:[(0,o.jsx)(n.$n,{className:"w-full",variant:"secondary",onClick:C,tabIndex:-1,children:s("I am not over 18","I am not over 18")}),(0,o.jsx)(n.$n,{className:"w-full",variant:"primary",onClick:b,children:s("I am 18 or older","I am 18 or older")})]}),f?null:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"relative flex items-center justify-center w-full",children:[(0,o.jsx)(m.w,{className:"absolute -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"}),(0,o.jsx)("p",{className:"relative px-2 py-1 mx-auto text-xs bg-background text-secondary",children:s("Or","Or")})]}),(0,o.jsx)(n.$n,{asChild:!0,variant:"secondary",size:"lg",onClick:S,children:(0,o.jsx)("a",{href:"sign-in",children:s("Sign in or create an account","Sign in or create an account")})})]})]}),"nopass"===h&&(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(n.$n,{className:"w-full mt-2",variant:"primary",size:"lg",onClick:R,children:s("Start a new chat","Start a new chat")})})]})}},29938:(e,t,s)=>{s.d(t,{Uk:()=>c,X4:()=>l,jN:()=>v,yo:()=>g});var o=s(65258),n=s(38541),i=s.n(n),r=s(6132),a=s(95158);let d="custom_personality_id",l={personalityId:d,name:"Custom",prompt:"",description:"Responds to you as you please.",isPreset:!1};function c(e){return!!e&&(e===d||36===e.length)}function u(e){return{name:e.name,content:[{text:e.prompt}]}}function h(e){var t,s;return{personalityId:e.systemPromptId||"",name:e.name||l.name,prompt:(null==(s=e.content)||null==(t=s[0])?void 0:t.text)||"",description:l.description,isPreset:!1}}let p={promiseById:{},byId:{},list:[],draftPromptById:{}};class m{constructor(e,t){this.set=e,this.get=t,this.promiseById=p.promiseById,this.byId=p.byId,this.list=p.list,this.draftPromptById=p.draftPromptById,this.clear=()=>{this.set(p)},this.upsertPersonality=(0,o.el)(this.set,"byId","personalityId"),this.appendPersonalities=(0,o.BC)(this.set,"byId","personalityId"),this.removePersonality=(0,o.TF)(this.set,"byId"),this.idsertPersonalityPromise=(0,o.q5)(this.set,"promiseById"),this.removePersonalityPromise=(0,o.TF)(this.set,"promiseById"),this.upsertDraftPrompt=(0,o.q5)(this.set,"draftPromptById"),this.fetchCreatePersonality=e=>{let t=this.get(),s=a.eb.systemPromptRepositoryCreateSystemPrompt({body:u(e)}).then(e=>{let t=h(e);return t.description=l.description,t}).then(e=>(t.upsertPersonality(e),t.idsertPersonalityPromise(s,e.personalityId),e));return s},this.fetchUpdatePersonality=e=>{let t=this.get(),s=a.eb.systemPromptRepositoryUpdateSystemPrompt({systemPromptId:e.personalityId,body:u(e)}).then(e=>h(e)).then(e=>(t.upsertPersonality(e),e));return t.idsertPersonalityPromise(s,e.personalityId),s},this.fetchDeletePersonality=e=>(this.get().removePersonality(e.personalityId),a.eb.systemPromptRepositoryDeleteSystemPrompt({systemPromptId:e.personalityId})),this.fetchListPersonalities=()=>{let e=this.get();return a.eb.systemPromptRepositoryListSystemPrompts({body:{pageSize:100}}).then(e=>{var t;return(null==(t=e.assets)?void 0:t.map(h))||[]}).then(t=>(e.appendPersonalities(t),e.set(e=>({promiseById:{...e.promiseById,...i().mapValues(i().keyBy(t,"personalityId"),e=>Promise.resolve(e))}})),t))},this.fetchGetPersonality=e=>{let t=this.get(),s=e.personalityId;if(s in t.promiseById&&t.promiseById[s])return t.promiseById[s];let o=a.eb.systemPromptRepositoryGetSystemPrompt({systemPromptId:s}).then(e=>h(e)).then(e=>(t.upsertPersonality(e),t.idsertPersonalityPromise(o,e.personalityId),e));return o}}}let v=(0,o.y$)(m,"usePersonalityStore");(0,o.lB)(v,"byId","list",Object.values);let g=r.z.object({personalityId:r.z.string(),name:r.z.string(),prompt:r.z.string(),description:r.z.string(),isPreset:r.z.boolean()});r.z.array(g)},32507:(e,t,s)=>{s.d(t,{Fp:()=>K,J1:()=>H,P3:()=>G,XO:()=>F,YT:()=>Q,ux:()=>z});var o=s(17703),n=s(65258),i=s(38541),r=s.n(i),a=s(39116),d=s(12110),l=s(88382),c=s(61657);let u=new d.w("/files"),h=new d.w("/workspace"),p=new d.w("/workspace/:id"),m=new d.w("/projects"),v=new d.w("/project"),g=new d.w("/project/:id"),I=new d.w("/chat/:id"),f=new d.w("/chat"),y=new d.w("/c/:id"),S=new d.w("/c"),b=new d.w("/images"),C=new d.w("/imagine"),R=new d.w("/imagine/favorites"),w=new d.w("/imagine/post/:id"),k=new d.w("/clear-cache"),_=new d.w("/tasks"),M=new d.w("/plans"),T=new d.w("/finance/:ticker"),P=new d.w("/faq"),x=new d.w("/faq/:anchor"),B=new d.w("/share-links"),E=new d.w("/deleted-conversations"),V=new d.w("/history"),A=["conversations","attachments"],N=["name","size","used","created"],O=["conversations","shared-with-me"],U="used",D=["image","document","spreadsheet","code","pdf"],L=["user","grok"],z="1735c097-cfe2-42ec-809d-b2cd8e806e9d",q="deepsearch";class j{constructor(e,t){this.set=e,this.get=t,this.route=$(globalThis.window.location),this.handleExternalChange=()=>{let e=this.get().route,t=$(globalThis.window.location);r().isEqual(e,t)||this.set({route:t})},this.push=e=>{var t;let s=this.get().route;if(r().isEqual(s,e))return;let o=H(K(e,s));null==(t=globalThis)||t.window.history.pushState({},"",o),this.set({route:X(e,s)})},this.replace=e=>{var t;let s=this.get().route;if(r().isEqual(s,e))return;let o=H(K(e,s));null==(t=globalThis)||t.window.history.replaceState({},"",o),this.set({route:X(e,s)})}}}let F=(0,n.MQ)(j,"useRoutingStore");function G(){let e=(0,a.useRouter)();(0,l.useEffect)(()=>F.subscribe((t,s)=>{let o=t.route.page;if("unknown"===s.route.page&&"unknown"!==o){let o=H(K(t.route,s.route));e.push(o)}}),[e]),(0,l.useEffect)(()=>{let e=F.getState().handleExternalChange;return window.addEventListener("popstate",e),()=>{window.removeEventListener("popstate",e)}},[])}function Q(){(0,l.useEffect)(()=>(F.getState().handleExternalChange(),()=>{F.setState({route:{page:"unknown"}})}),[])}function W(e,t,s){return e.includes(t)?t:s}function H(e){if(e.query&&"string"!=typeof e.query)for(let t in e.query)void 0===e.query[t]&&delete e.query[t];return(0,c.format)(e)}function K(e,t){switch((e=X(e,t)).page){case"main":return{pathname:"/",query:{voice:e.voice?"true":void 0}};case"files":return{pathname:"/files",query:{file:e.fileId||void 0,emptyView:"default"===e.emptyView?void 0:e.emptyView,search:e.search||void 0,sort:e.sort===U?void 0:e.sort,fileType:e.fileType,createdBy:e.createdBy}};case"workspaces":return{pathname:"/project"};case"workspace":return{pathname:"/project/"+(e.workspaceId===z?q:e.workspaceId),query:{tab:e.tab||void 0,chat:e.conversationId||void 0}};case"chat":if(e.temporary)return{pathname:"/c"};if(!e.conversationId)return{pathname:"/"};return{pathname:"/c/"+e.conversationId};case"unknown":return{pathname:"/"};case"images":return{pathname:"/images".concat(e.tab?"/".concat(e.tab):"")};case"tasks":return{pathname:"/tasks",query:{taskId:e.taskId||void 0,tab:e.tab||void 0}};case"plans":return{pathname:"/plans"};case"finance":return{pathname:"/finance/"+e.ticker,query:{chat:e.conversationId||void 0,query:e.query||void 0}};case"faq":return{pathname:"/faq"+(e.anchor?"/".concat(e.anchor):"")};case"share-links":return{pathname:"/share-links"};case"deleted-conversations":return{pathname:"/deleted-conversations"};case"history":return{pathname:"/history",query:{tab:e.tab||void 0}};case"imagine":return{pathname:"/imagine"};case"imagine-favorites":return{pathname:"/imagine/favorites"};case"imagine-post":return{pathname:"/imagine/post/"+e.postId};case"clear-cache":return{pathname:"/clear-cache"};default:let s=e;return(0,o.vV)("routeToUrlObject","Unhandled route case:"+s),{}}}function $(e){return function(e,t){var s,o,n,i,r,a,d,l,c,j;if("/"===e)return{page:"main",voice:"true"===t.get("voice")};if(u.test(e))return{page:"files",fileId:t.get("file")||null,emptyView:"image"===t.get("emptyView")?"image":"default",search:t.get("search")||void 0,sort:null!=(s=W(N,t.get("sort")))?s:U,fileType:W(D,t.get("fileType")),createdBy:W(L,t.get("createdBy"))};if(h.test(e)||v.test(e)||m.test(e))return{page:"workspaces"};let F=p.test(e);if(null==F?void 0:F.id){let e=null!=(o=t.get("tab"))?o:"",s=null!=(n=t.get("chat"))?n:"";return{page:"workspace",workspaceId:F.id===q?z:F.id,tab:null!=(i=W(A,e))?i:null,conversationId:s}}let G=g.test(e);if(null==G?void 0:G.id){let e=null!=(r=t.get("tab"))?r:"",s=null!=(a=t.get("chat"))?a:"";return{page:"workspace",workspaceId:G.id===q?z:G.id,tab:null!=(d=W(A,e))?d:null,conversationId:s}}let Q=I.test(e)||y.test(e);if(null==Q?void 0:Q.id)return{page:"chat",conversationId:Q.id,temporary:!1};if(f.test(e)||S.test(e))return{page:"chat",conversationId:null,temporary:!0};if(b.test(e))return{page:"images"};if(C.test(e))return{page:"imagine"};let H=w.test(e);if(H)return{page:"imagine-post",postId:H.id};if(R.test(e))return{page:"imagine-favorites"};if(k.test(e))return{page:"clear-cache"};if(_.test(e))return{page:"tasks",taskId:t.get("taskId"),tab:t.get("tab")};if(M.test(e))return{page:"plans"};let K=T.test(e);return K?{page:"finance",ticker:K.ticker,conversationId:t.get("chat"),query:t.get("query")}:P.test(e)||x.test(e)?{page:"faq",anchor:null!=(c=null==(l=x.test(e))?void 0:l.anchor)?c:null}:B.test(e)?{page:"share-links"}:E.test(e)?{page:"deleted-conversations"}:V.test(e)?{page:"history",tab:null!=(j=W(O,t.get("tab")))?j:null}:{page:"unknown"}}(e.pathname,new URLSearchParams(e.search))}function X(e,t){return e.page===t.page&&(e=function(e){let t={...e};for(let e of Object.keys(t))void 0===t[e]&&delete t[e];return t}(e),e={...t,...e}),e}},34500:(e,t,s)=>{s.d(t,{BE:()=>h,I6:()=>v,Uz:()=>d,_s:()=>a,gk:()=>m,tb:()=>p,zj:()=>u});var o=s(79342),n=s(88382),i=s(62961),r=s(61312);let a=e=>{let{shouldScaleBackground:t=!0,...s}=e;return(0,o.jsx)(i._.Root,{shouldScaleBackground:t,...s})};a.displayName="Drawer";let d=i._.Trigger,l=i._.Portal;i._.Close;let c=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,o.jsx)(i._.Overlay,{ref:t,className:(0,r.cn)("fixed inset-0 bg-black/20 dark:bg-black/80",s),...n})});c.displayName=i._.Overlay.displayName;let u=n.forwardRef((e,t)=>{let{className:s,overlayClassName:n,disableDrag:a,children:d,...u}=e;return(0,o.jsxs)(l,{children:[(0,o.jsx)(c,{className:n}),(0,o.jsxs)(i._.Content,{ref:t,className:(0,r.cn)("fixed inset-x-0 bottom-0 mt-24 flex h-auto flex-col rounded-t-[24px] bg-surface-base dark:border dark:border-border-l1",s),onCloseAutoFocus:e=>{e.preventDefault(),document.body.style.pointerEvents=""},...u,children:[a?null:(0,o.jsx)("div",{className:"flex-shrink-0 w-12 h-1 mx-auto mt-3 mb-0 rounded-full bg-secondary/80"}),d]})]})});u.displayName="DrawerContent";let h=e=>{let{className:t,...s}=e;return(0,o.jsx)("div",{className:(0,r.cn)("grid gap-1.5 p-4 text-center sm:text-left",t),...s})};h.displayName="DrawerHeader";let p=e=>{let{className:t,...s}=e;return(0,o.jsx)("div",{className:(0,r.cn)("mt-auto flex flex-col gap-2 p-4",t),...s})};p.displayName="DrawerFooter";let m=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,o.jsx)(i._.Title,{ref:t,className:(0,r.cn)("text-lg font-semibold leading-none tracking-tight",s),...n})});m.displayName=i._.Title.displayName;let v=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,o.jsx)(i._.Description,{ref:t,className:(0,r.cn)("text-sm text-muted-foreground",s),...n})});v.displayName=i._.Description.displayName},36936:(e,t,s)=>{s.d(t,{V:()=>i});var o=s(65258);class n{constructor(e,t){this.set=e,this.get=t,this.models=[],this.unavailableModels=[],this.defaultAnonModelId="",this.defaultFreeModelId="",this.defaultProModelId="",this.modelById={},this.isPending=!1}}let i=(0,o.y$)(n,"useModelsStore")},38614:(e,t,s)=>{s.d(t,{OF:()=>X,He:()=>j,vC:()=>q,aP:()=>Q});var o=s(81884),n=s(5790),i=s(58192),r=s(44845),a=s(83626),d=s(17703),l=s(33960);class c{static getInstance(){return c.instance||(c.instance=new c),c.instance}startVoiceSession(e){let{sessionId:t,voiceId:s,personalityId:o,customInstructions:n,playbackSpeed:i,enableSearch:r,enableVision:a}=e,l=Date.now();this.currentSession={sessionId:t,requestId:null,connectionStartTime:l,voiceId:s,personalityId:o,customInstructions:n,playbackSpeed:i,enableSearch:r,enableVision:a,userTurns:0,assistantTurns:0,errors:[],personalityChanges:[],voiceChanges:[],manualMessagesSent:0},(0,d.iu)("voice_session_started",t,{location:"voice-metrics-tracker",sessionId:t,voiceId:s,personalityId:o||"none",customInstructions:n||"none",playbackSpeed:i.toString(),enableSearch:r.toString(),enableVision:a.toString()}),this.trackPersonalityChange({fromPersonality:null,toPersonality:o,fromCustomInstructions:null,toCustomInstructions:n}),this.trackVoiceChange({fromVoice:null,toVoice:s}),this.trackPlaybackSpeedChange({fromSpeed:1,toSpeed:i})}trackLivekitTokenReceived(e){this.currentSession&&!this.currentSession.livekitTokenReceivedTime&&(this.currentSession.livekitTokenReceivedTime=Date.now(),this.currentSession.requestId=e,(0,d.iu)("voice_livekit_token_received",this.currentSession.sessionId,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:e||"unavailable",timestamp:this.currentSession.livekitTokenReceivedTime.toString(),duration:(this.currentSession.livekitTokenReceivedTime-this.currentSession.connectionStartTime).toString()}))}trackLocalTrackSubscribed(){this.currentSession&&this.currentSession.livekitTokenReceivedTime&&!this.currentSession.trackSubscribedTime&&(this.currentSession.trackSubscribedTime=Date.now(),(0,d.iu)("voice_local_track_subscribed",this.currentSession.sessionId,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",timestamp:this.currentSession.trackSubscribedTime.toString(),duration:(this.currentSession.trackSubscribedTime-this.currentSession.livekitTokenReceivedTime).toString()}))}trackConversationCreated(e){let{conversationId:t,connectionState:s}=e;if(!this.currentSession||!this.currentSession.trackSubscribedTime||this.currentSession.conversationCreatedTime)return;let o=Date.now();this.currentSession.conversationCreatedTime=o,(0,d.iu)("voice_conversation_created",this.currentSession.sessionId,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",conversationId:t||"unavailable",connectionState:s,timestamp:o.toString(),duration:(o-this.currentSession.trackSubscribedTime).toString()})}trackConnectionReady(){if(!this.currentSession)return;let e=Date.now();this.currentSession.readyTime=e,(0,d.iu)("voice_connection_ready",this.currentSession.sessionId,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",timestamp:e.toString(),duration:(e-this.currentSession.connectionStartTime).toString()})}trackUserTurn(){this.currentSession&&this.currentSession.userTurns++}trackAssistantTurn(){this.currentSession&&this.currentSession.assistantTurns++}trackManualMessage(){this.currentSession&&this.currentSession.manualMessagesSent++}trackPersonalityChange(e){let{fromPersonality:t,toPersonality:s,fromCustomInstructions:o,toCustomInstructions:n}=e;if(!this.currentSession)return;let i={fromPersonality:t,toPersonality:s,fromCustomInstructions:o,toCustomInstructions:n,timestamp:Date.now()};this.currentSession.personalityChanges.push(i),this.currentSession.personalityId=s,this.currentSession.customInstructions=n,(0,d.iu)("voice_personality_changed",n?"custom-instructions":s||void 0,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",fromPersonality:t||"none",toPersonality:s||"none",fromCustomInstructions:o||"none",toCustomInstructions:n||"none",changeCount:this.currentSession.personalityChanges.length.toString()})}trackVoiceChange(e){let{fromVoice:t,toVoice:s}=e;if(!this.currentSession)return;let o={fromVoice:t,toVoice:s,timestamp:Date.now()};this.currentSession.voiceChanges.push(o),this.currentSession.voiceId=s,(0,d.iu)("voice_voice_changed",s,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",fromVoice:t||"none",toVoice:s,changeCount:this.currentSession.voiceChanges.length.toString()})}trackPlaybackSpeedChange(e){let{fromSpeed:t,toSpeed:s}=e;this.currentSession&&(this.currentSession.playbackSpeed=s,(0,d.iu)("voice_playback_speed_changed",s.toString(),{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",fromSpeed:t.toString(),toSpeed:s.toString()}))}trackScreenShareStart(){this.currentSession&&(this.currentSession.screenShareStartTime=Date.now(),(0,d.iu)("voice_screen_share_started",void 0,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable"}))}trackScreenShareEnd(){if(!this.currentSession||!this.currentSession.screenShareStartTime)return;let e=Date.now()-this.currentSession.screenShareStartTime;this.currentSession.screenShareDuration=(this.currentSession.screenShareDuration||0)+e,this.currentSession.screenShareStartTime=void 0,(0,d.iu)("voice_screen_share_ended",e.toString(),{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",duration:e.toString(),totalScreenShareDuration:this.currentSession.screenShareDuration.toString()})}trackError(e,t){if(!this.currentSession)return;let s={type:e,message:t,timestamp:Date.now()};this.currentSession.errors.push(s),(0,d.iu)("voice_session_error",e,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",errorType:e,errorMessage:t,errorCount:this.currentSession.errors.length.toString()})}endVoiceSession(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"user_initiated";if(!this.currentSession)return;let t=Date.now();this.currentSession.endTime=t,this.currentSession.endReason=e,this.currentSession.readyTime&&(this.currentSession.totalDuration=t-this.currentSession.readyTime),this.currentSession.screenShareStartTime&&this.trackScreenShareEnd(),(0,d.iu)("voice_session_ended",this.currentSession.sessionId,{location:"voice-metrics-tracker",sessionId:this.currentSession.sessionId,requestId:this.currentSession.requestId||"unavailable",endReason:e,totalDuration:(this.currentSession.totalDuration||0).toString(),livekitTokenReceivedDuration:(this.currentSession.livekitTokenReceivedTime?this.currentSession.livekitTokenReceivedTime-this.currentSession.connectionStartTime:0).toString(),trackSubscribedDuration:(this.currentSession.trackSubscribedTime&&this.currentSession.livekitTokenReceivedTime?this.currentSession.trackSubscribedTime-this.currentSession.livekitTokenReceivedTime:0).toString(),conversationCreatedDuration:(this.currentSession.conversationCreatedTime&&this.currentSession.trackSubscribedTime?this.currentSession.conversationCreatedTime-this.currentSession.trackSubscribedTime:0).toString(),readyDuration:(this.currentSession.readyTime?this.currentSession.readyTime-this.currentSession.connectionStartTime:0).toString(),userTurns:this.currentSession.userTurns.toString(),assistantTurns:this.currentSession.assistantTurns.toString(),totalTurns:(this.currentSession.userTurns+this.currentSession.assistantTurns).toString(),screenShareDuration:(this.currentSession.screenShareDuration||0).toString(),personalityChanges:this.currentSession.personalityChanges.length.toString(),voiceChanges:this.currentSession.voiceChanges.length.toString(),errors:this.currentSession.errors.length.toString(),manualMessages:this.currentSession.manualMessagesSent.toString(),voiceId:this.currentSession.voiceId,personalityId:this.currentSession.personalityId||"none",customInstructions:this.currentSession.customInstructions||"none",enableSearch:this.currentSession.enableSearch.toString(),enableVision:this.currentSession.enableVision.toString()}),this.currentSession=null}trackConnectionStateChange(e,t){this.currentSession&&"disconnected"===t&&"disconnecting"!==e&&this.trackError("unexpected_disconnection","Connection changed from ".concat(e," to ").concat(t))}constructor(){this.currentSession=null}}c.instance=null;let u=c.getInstance();var h=s(65258),p=s(95158),m=s(13926),v=s(49972),g=s(36936),I=s(29938),f=s(97960),y=s(32507),S=s(44347),b=s(56907),C=s(83318),R=s(38541),w=s.n(R),k=s(12110),_=s(14908),M=s(27853),T=s(6132),P=s(82509),x=s(17823),B=s(79342);let E=[1];var V=s(11750),A=s(98100),N=s(88382),O=s(65146);let U=e=>{let{modelName:t,reasoningMode:s,waitTimeSeconds:o}=e,{t:n}=(0,O.Bd)("chat"),{modelById:i}=(0,A.GB)(),r=(0,N.useMemo)(()=>{var e;return(null==(e=i[t])?void 0:e.name)||t},[i,t]),a=(0,N.useMemo)(()=>{let e=Math.floor(o/3600),t=Math.floor(o%3600/60);return e>0&&t>0?"".concat(n("time.hours",{defaultValue_one:"{{count}} hour",defaultValue_other:"{{count}} hours",count:e})," ").concat(n("time.minutes",{count:t,defaultValue_one:"{{count}} minutes",defaultValue_other:"{{count}} minutes"})):e>0?n("time.hours",{defaultValue_one:"{{count}} hour",defaultValue_other:"{{count}} hours",count:e}):n("time.minutes",{count:t,defaultValue_one:"{{count}} minutes",defaultValue_other:"{{count}} minutes"})},[o,n]),d=(0,N.useMemo)(()=>"DEEPSEARCH"===s?n("Rate Limit Reached.description-deepsearch","Query limit reached for {{modelName}} with DeepSearch. Limit refreshes in {{time}}.",{modelName:r,time:a}):"DEEPERSEARCH"===s?n("Rate Limit Reached.description-deepersearch","Query limit reached for {{modelName}} with DeeperSearch. Limit refreshes in {{time}}.",{modelName:r,time:a}):"REASONING"===s?n("Rate Limit Reached.description-reasoning","Query limit reached for {{modelName}} with Think. Limit refreshes in {{time}}.",{modelName:r,time:a}):n("Rate Limit Reached.description","Query limit reached for {{modelName}}. Limit refreshes in {{time}}.",{modelName:r,time:a}),[a,r,n,s]);return(0,B.jsxs)("div",{className:"flex items-center gap-2",children:[(0,B.jsx)(V.Kgj,{className:"size-5"}),(0,B.jsx)("div",{className:"font-semibold text-xs",children:d})]})},D=e=>{let{modelName:t,reasoningMode:s,remainingQueries:o,windowSizeSeconds:n}=e,{t:i}=(0,O.Bd)("chat"),{modelById:r}=(0,A.GB)(),a=(0,N.useMemo)(()=>{var e;return(null==(e=r[t])?void 0:e.name)||t},[r,t]),d=(0,N.useMemo)(()=>{let e=Math.floor(n/3600),t=Math.floor(n%3600/60);return e>0&&t>0?"".concat(i("time.hours",{defaultValue_one:"{{count}} hour",defaultValue_other:"{{count}} hours",count:e})," ").concat(i("time.minutes",{count:t,defaultValue_one:"{{count}} minutes",defaultValue_other:"{{count}} minutes"})):e>0?i("time.hours",{defaultValue_one:"{{count}} hour",defaultValue_other:"{{count}} hours",count:e}):i("time.minutes",{count:t,defaultValue_one:"{{count}} minutes",defaultValue_other:"{{count}} minutes"})},[n,i]),l=(0,N.useMemo)(()=>"DEEPSEARCH"===s?i("Remaining Queries.description-deepsearch",{modelName:a,count:o,time:d,defaultValue_one:"One query left for {{modelName}} with DeepSearch. Limit resets every {{time}}.",defaultValue_other:"You have {{count}} remaining queries for {{modelName}} with DeepSearch. Limit resets every {{time}}."}):"DEEPERSEARCH"===s?i("Remaining Queries.description-deepersearch",{modelName:a,count:o,time:d,defaultValue_one:"One query left for {{modelName}} with DeeperSearch. Limit resets every {{time}}.",defaultValue_other:"You have {{count}} remaining queries for {{modelName}} with DeeperSearch. Limit resets every {{time}}."}):"REASONING"===s?i("Remaining Queries.description-reasoning",{modelName:a,count:o,time:d,defaultValue_one:"One query left for {{modelName}} with Think. Limit resets every {{time}}.",defaultValue_other:"You have {{count}} remaining queries for {{modelName}} with Think. Limit resets every {{time}}."}):i("Remaining Queries.description",{modelName:a,count:o,time:d,defaultValue_one:"One query left for {{modelName}}. Limit resets every {{time}}.",defaultValue_other:"You have {{count}} remaining queries for {{modelName}}. Limit resets every {{time}}."}),[o,a,d,i,s]);return(0,B.jsxs)("div",{className:"flex items-center gap-2",children:[(0,B.jsx)(V.Kgj,{className:"size-5"}),(0,B.jsx)("div",{className:"text-xs font-semibold",children:l})]})};function L(e){p.tW.rateLimitsGetRateLimits({body:e}).then(t=>{void 0!==t.remainingQueries&&E.includes(t.remainingQueries)?_.oR.info((0,B.jsx)(D,{reasoningMode:e.requestKind,modelName:e.modelName,remainingQueries:t.remainingQueries,windowSizeSeconds:t.windowSizeSeconds||0}),{duration:7e3}):0===t.remainingQueries&&t.waitTimeSeconds&&_.oR.info((0,B.jsx)(U,{reasoningMode:e.requestKind,modelName:e.modelName,waitTimeSeconds:t.waitTimeSeconds}),{duration:7e3})}).catch(e=>{(0,d.vV)("chat-page-store:checkRateLimits",e)})}function z(e,t){let s=function(e,t){let s=e.trim().replace(/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g,"");return s.length>200?s.slice(0,200)+"...":s}(e,200);_.oR.info(s,{duration:7e3}),(0,d.iu)("show_disclaimer",s,{location:"chat-page-store",conversationId:t})}function q(e){if(e)switch(e){case"fast":return m.it.ModelModeFast;case"expert":return m.it.ModelModeExpert;case"heavy":return m.it.ModelModeHeavy;case"auto":return m.it.ModelModeAuto;case"grok-4-mini-thinking":return m.it.ModelModeGrok4MiniThinking;default:return(0,d.vV)("chat-page-store:modelModeToModelConfigModelMode","Invalid model mode: ".concat(e)),m.it.ModelModeUnknown}}function j(e){if(e)switch(e){case m.it.ModelModeFast:return"fast";case m.it.ModelModeExpert:return"expert";case m.it.ModelModeHeavy:return"heavy";case m.it.ModelModeAuto:return"auto";case m.it.ModelModeUnknown:return;case m.it.ModelModeGrok4MiniThinking:return"grok-4-mini-thinking";default:if(5===e)return"grok-4-mini-thinking";(0,d.vV)("chat-page-store:modelConfigModelModeToModelMode","Invalid model config mode: ".concat(e));return}}T.z.union([T.z.literal("auto"),T.z.literal("image"),T.z.literal("search"),T.z.literal("modelOnly"),T.z.literal("noSearch")]),T.z.union([T.z.literal("chat"),T.z.literal("voice")]);let F="/"===globalThis.location.pathname;class G{constructor(e,t){var s=this;this.set=e,this.get=t,this.sidePanelStack=[],this.activeModelId=i.Sk,this.isRateLimited=!1,this.isThinkingRateLimited=!1,this.isDeepSearchRateLimited=!1,this.isUnauthenticated=!1,this.hasDismissedDisclaimer=!1,this.conversationMode="chat",this.outputMode="auto",this.reasoningMode="none",this.queryBarExpanded=!1,this.isTypingDebounce=!1,this.showStreamingIndicator=!1,this.modelMode="auto",this.staleOptimisticMessageIds=new Set,this.requestShareDialogOpen=!1,this.metadata={},this.projectId=void 0,this.selectedPersonalityId=void 0,this.customPersonality=void 0,this.quotedText=void 0,this.queryByConversationId={},this.chatPageLoaded=!1,this.isDeeperSearchSelected=!1,this.livekitRoom=null,this.livekitToken=null,this.livekitRequestId=null,this.voiceConnectionStatus="disconnected",this.voiceId="Ara",this.voicePersonalityId="assistant",this.voiceCustomInstructions=null,this.voicePlaybackSpeed=1,this.voiceModeTimeoutId=null,this.currentVoiceSessionId=null,this.voiceSessionConversationId=null,this.exitVoiceModePromise=null,this.setModelMode=(0,h.kp)(this.set,"modelMode"),this.setConversationId=(0,h.kp)(this.set,"conversationId"),this.setProjectId=(0,h.kp)(this.set,"projectId"),this.setOptimisticConversationId=(0,h.kp)(this.set,"optimisticConversationId"),this.setLastMessageId=(0,h.kp)(this.set,"lastMessageId"),this.setQuotePopupData=(0,h.kp)(this.set,"quotePopupData"),this.setSidePanelContent=function(e){var t;let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=s.get(),i=n.sidePanelContent;if((o=o||["messageThread"].includes(null!=(t=null==i?void 0:i.type)?t:"_false"))&&void 0===e)return void s.set({sidePanelContent:n.sidePanelStack.pop()});o&&void 0!==i&&s.set({sidePanelStack:[...n.sidePanelStack,i]}),s.set({sidePanelContent:e})},this.closeSidePanel=()=>{this.set({sidePanelStack:[]}),this.set({sidePanelContent:void 0})},this.setSidePanelStack=(0,h.kp)(this.set,"sidePanelStack"),this.toggleSidePanelContent=e=>{let t=this.get().sidePanelContent;(null==t?void 0:t.type)===e.type&&w().isEqual(t.data,e.data)?this.setSidePanelContent(void 0,!1):this.setSidePanelContent(e,!1)},this.setStreamedMessageId=(0,h.kp)(this.set,"streamedMessageId"),this.setActiveModelId=(0,h.kp)(this.set,"activeModelId"),this.setSelectedSystemPromptId=(0,h.kp)(this.set,"selectedSystemPromptId"),this.setIsRateLimited=(0,h.kp)(this.set,"isRateLimited"),this.setIsUnauthenticated=(0,h.kp)(this.set,"isUnauthenticated"),this.setHasDismissedDisclaimer=(0,h.kp)(this.set,"hasDismissedDisclaimer"),this.setOptimisticMessageId=(0,h.kp)(this.set,"optimisticMessageId"),this.setConversationMode=(0,h.kp)(this.set,"conversationMode"),this.setOutputMode=(0,h.kp)(this.set,"outputMode"),this.setReasoningMode=(0,h.kp)(this.set,"reasoningMode"),this.setChatPageLoaded=(0,h.kp)(this.set,"chatPageLoaded"),this.setDefaultAnonModelId=(0,h.kp)(this.set,"defaultAnonModelId"),this.setDefaultFreeModelId=(0,h.kp)(this.set,"defaultFreeModelId"),this.setDefaultProModelId=(0,h.kp)(this.set,"defaultProModelId"),this.setMetadata=(0,h.kp)(this.set,"metadata"),this.setSelectedPersonalityId=(0,h.kp)(this.set,"selectedPersonalityId"),this.setCustomPersonality=(0,h.kp)(this.set,"customPersonality"),this.setQuotedText=(0,h.kp)(this.set,"quotedText"),this.idsetQueryByConversationId=(0,h.q5)(this.set,"queryByConversationId"),this.setQueryBarExpanded=e=>this.set({queryBarExpanded:e}),this.setIsTypingDebounce=e=>this.set({isTypingDebounce:e}),this.setIsDeeperSearchSelected=(0,h.kp)(this.set,"isDeeperSearchSelected"),this.setLivekitRoom=(0,h.kp)(this.set,"livekitRoom"),this.setLivekitToken=(0,h.kp)(this.set,"livekitToken"),this.setLivekitRequestId=(0,h.kp)(this.set,"livekitRequestId"),this.setVoiceConnectionStatus=e=>{let t=this.get().voiceConnectionStatus;this.set({voiceConnectionStatus:e}),this.get().currentVoiceSessionId&&t!==e&&(u.trackConnectionStateChange(t,e),"ready"===e&&u.trackConnectionReady())},this.setVoiceId=(0,h.kp)(this.set,"voiceId"),this.setVoicePersonalityId=(0,h.kp)(this.set,"voicePersonalityId"),this.setVoiceCustomInstructions=(0,h.kp)(this.set,"voiceCustomInstructions"),this.setVoicePlaybackSpeed=(0,h.kp)(this.set,"voicePlaybackSpeed"),this.setVoiceModeTimeoutId=(0,h.kp)(this.set,"voiceModeTimeoutId"),this.setCurrentVoiceSessionId=(0,h.kp)(this.set,"currentVoiceSessionId"),this.setVoiceSessionConversationId=(0,h.kp)(this.set,"voiceSessionConversationId"),this.setStaleOptimisticMessageIds=(0,h.kp)(this.set,"staleOptimisticMessageIds"),this.setRequestShareDialogOpen=(0,h.kp)(this.set,"requestShareDialogOpen"),this.setSideBySideConfig=(0,h.kp)(this.set,"sideBySideConfig"),this.setSurvey=(0,h.kp)(this.set,"survey"),this.isErrorRetryable=e=>{let t=(0,l.G1)(e);return 429===t?(this.setIsRateLimited(!0),!1):401===t?(this.setIsUnauthenticated(!0),!1):!(t&&t>=400&&t<500||e.message.includes("Failed to respond")||e.message.includes(b.CZ)||e.message.includes(b.S3))},this.establishNewConversation=async e=>{let t,s,o,n,{temporary:l,message:c,fileAttachmentIds:u,webpageUrls:h,toolOverrides:p,isPreset:m,persona:v,enableRetries:g,disableArtifactDiff:y,imageEditUri:b,workspaceIds:C,responseMetadata:R,isFromGrokFiles:k,disableToolComposer:_=!1,disableMemory:M=!1,ff:T,customInstructions:P,modelIdOverride:x}=e,B=this.get(),E=f.A3.getState(),V=S.C$.getState(),A=I.jN.getState();this.setProjectId(void 0);let N=w().get(A.byId,V.userSettings.preferences.selectedSystemPromptId||""),O=null!=x?x:B.activeModelId,U=$(void 0,B.reasoningMode,O),D=(null==N?void 0:N.prompt)||B.customPersonality,q=v&&O!==i.E8?"".concat(D,"\n\n").concat(v.prompt,"."):D,j=!1,G={...B.metadata,...R};if(B.setMetadata({}),F){let e=performance.now();(0,d.N8)("establishNewConversation",{type:"user_time_to_query",valueMs:e}),(0,d.iu)("user_time_to_query",e.toFixed(0),{location:"chat-page-store"}),F=!1}return new Promise((e,i)=>{E.streamCreateAndRespond({temporary:l,message:c,modelName:O,fileAttachmentIds:u,webpageUrls:h,systemPromptName:null==v?void 0:v.systemPromptName,personaId:null==v?void 0:v.personaId,toolOverrides:null!=p?p:W(B.outputMode,U),isPreset:m,customInstructions:P,customPersonality:q,deepsearchPreset:(0,r.Ku)(U),isReasoning:"think"===U,imageEditUri:b,enableRetries:g,disableArtifactDiff:y,workspaceIds:C,responseMetadata:G,isFromGrokFiles:k,disableToolComposer:_,disableMemory:M,modelMode:B.modelMode,onOptimisticConversation:e=>{let{conversationId:s}=e;B.setOptimisticConversationId(s),t=s},onOptimisticResponse:e=>{let{responseId:t,conversationId:s}=e;this.get().optimisticConversationId===s&&B.setOptimisticMessageId(t),n=t},onStart:e=>{let t=this.get(),s=e[0];t.optimisticConversationId===(null==s?void 0:s.conversationId)&&B.setStreamedMessageId(null==s?void 0:s.responseId)},onConversation:o=>{this.get().optimisticConversationId===t&&(B.setConversationId(o.conversationId),B.setOptimisticConversationId(void 0)),s=o.conversationId,j=!0,e(o)},onUserResponse:e=>{let t=this.get();if(t.conversationId===e.conversationId&&(B.setLastMessageId(e.responseId),B.setOptimisticMessageId(e.responseId)),n){let e=new Set([...t.staleOptimisticMessageIds,n]);B.setStaleOptimisticMessageIds(e)}},onSideBySideConfig:(e,s)=>{let o=this.get();(s===t||s===o.conversationId)&&B.setSideBySideConfig(e)},onSurvey:e=>{B.setSurvey(e)},onStartExperiment:e=>{},onRealResponseId:e=>{let n=this.get();(n.conversationId===s||n.optimisticConversationId===t)&&(B.setStreamedMessageId(e),o=e)},onCitations:()=>{},onDisclaimer:v?()=>{}:z,onHasImage:(0,a.S)(()=>V.setShowAgeVerification(!0)),onClose:e=>{let n=this.get(),a=w().first(e),l=(n.conversationId===s||n.optimisticConversationId===t)&&n.streamedMessageId===o;a&&n.lastMessageId===a.parentResponseId&&l&&(B.setLastMessageId(a.responseId),B.setStreamedMessageId(a.responseId)),L({modelName:O,requestKind:(0,r.ot)(U)}),l&&j?B.setOptimisticConversationId(void 0):i(new d.HK("Not resolved by close"))},onWke:e=>{"RateLimitError"===e.name&&B.setIsRateLimited(!0),i(e)},onError:this.isErrorRetryable,ff:T}).catch(e=>{i(e)})})},this.sendResponse=async e=>{var t;let s,{message:o,parentResponseId:n,parentQuotedText:d,conversationId:l,fileAttachmentIds:c,webpageUrls:u,toolOverrides:h,setOpimisticUserResponse:p,setUserResponse:m,onOptimisticUserResponse:v,onError:g,imageEditUri:y,persona:b,enableRetries:C,disableArtifactDiff:R,metadata:k,followUpType:_,reasoningMode:M,isFromGrokFiles:T,resumeResponseId:P,disableToolComposer:x=!1,disableMemory:B=!1,modelIdOverride:E,ff:V,threadParentId:A,skipCancelCurrentInflightRequests:N,ctx:O,disableArtifact:U}=e,D=this.get(),q=O?O.getState():this.get(),j=O?O.getState().chatStateType:"normal",F=f.A3.getState(),G=S.C$.getState(),Q=I.jN.getState();q.setSurvey(void 0);let H=w().get(Q.byId,G.userSettings.preferences.selectedSystemPromptId||""),K=null!=E?E:D.activeModelId,X=void 0,J=null!=(t=(null==H?void 0:H.prompt)||D.customPersonality)?t:"",Y=b&&K!==i.E8?"".concat(J,"\n\n").concat(b.prompt,"."):J;q.setLastMessageId(n);let Z=$(M,D.reasoningMode,K),ee={...D.metadata,...k};return D.setMetadata({}),new Promise((e,t)=>{F.streamResponse({message:o,metadata:ee,parentResponseId:n,parentQuotedText:d,conversationId:l,modelName:K,systemPromptName:null==b?void 0:b.systemPromptName,fileAttachmentIds:c,webpageUrls:u,toolOverrides:{...W(D.outputMode,Z),...null!=h?h:{}},customInstructions:X,customPersonality:Y,deepsearchPreset:(0,r.Ku)(Z),isReasoning:"think"===Z,imageEditUri:y,enableRetries:C,disableArtifactDiff:R,disableArtifact:U,followUpType:_,isFromGrokFiles:T,resumeResponseId:P,disableToolComposer:x,disableMemory:B,threadParentId:A,modelMode:D.modelMode,skipCancelCurrentInflightRequests:N,onOptimisticUserResponse:e=>{p&&(q.setOptimisticMessageId(e.responseId),null==v||v(e))},onOptimisticModelResponse:e=>{q.setStreamedMessageId(e.responseId)},onStart:e=>{var t;q.setStreamedMessageId(null==(t=e[0])?void 0:t.responseId)},onUserResponse:e=>{m&&(q.setLastMessageId(e.responseId),q.setOptimisticMessageId(e.responseId))},onSideBySideConfig:(e,t)=>{D.setSideBySideConfig(e)},onSurvey:e=>{"thread"!==j&&q.setSurvey(e)},onStartExperiment:e=>{},onRealResponseId:e=>{q.setStreamedMessageId(e),s=e},onCitations:()=>{},onDisclaimer:b?()=>{}:z,onHasImage:(0,a.S)(()=>G.setShowAgeVerification(!0)),onClose:o=>{let n=O?O.getState():this.get(),i=w().first(o),a=n&&n.streamedMessageId===s;if(i&&a&&(n.setLastMessageId(i.responseId),n.setStreamedMessageId(i.responseId)),i){var d;let s=null!=(d=i.experimentIds)?d:[],n=o.filter(e=>s.includes(e.responseId)||e.responseId===(null==i?void 0:i.responseId));if(n.length>0&&n.every(e=>"closed"===e.state))e(n);else{let e=Error("Responses missing, errored, or not closed");null==g||g(e),t(e)}}else{let e=Error("First response is missing in responses");null==g||g(e),t(e)}L({modelName:K,requestKind:(0,r.ot)(Z)})},onWke:e=>{"RateLimitError"===e.name&&D.setIsRateLimited(!0),null==g||g(e),t(e)},onError:this.isErrorRetryable,ff:V}).catch(e=>{null==g||g(e),t(e)})})},this.reconnectToInflightResponses=async e=>{let{conversationId:t,enableRetries:s,ff:o,ctx:n,threadParentId:i}=e,l=this.get(),c=n?n.getState():l,u=f.A3.getState(),h=S.C$.getState(),p=l.activeModelId;try{let e=await u.fetchListInflightResponses(t);if(!e.length)return;let n=w().maxBy(e.filter(e=>i?e.threadParentId===i:!e.threadParentId),e=>new Date(e.createTime?e.createTime:0));if(!n)return;if(!n.responseId)return void(0,d.vV)("chat-page-store:reconnectToInflightResponses","Inflight response missing response id");if(!n.parentResponseId)return void(0,d.vV)("chat-page-store:reconnectToInflightResponses","Inflight response missing parent response id:");c.setLastMessageId(n.parentResponseId),await u.reconnectToResponse({inflightResponse:n,conversationId:t,modelName:p,parentResponseId:n.parentResponseId,enableRetries:s,isReasoning:"think"===l.reasoningMode,deepsearchPreset:(0,r.Ku)(l.reasoningMode),modelMode:l.modelMode,threadParentId:i,onStart:e=>{let t=e[0];t&&c.setStreamedMessageId(t.responseId)},onCitations:()=>{},onDisclaimer:z,onHasImage:(0,a.S)(()=>h.setShowAgeVerification(!0)),onClose:e=>{let t=w().first(e);t&&(c.setLastMessageId(t.responseId),c.setStreamedMessageId(void 0)),L({modelName:p,requestKind:(0,r.ot)(l.reasoningMode)})},onWke:e=>{"RateLimitError"===e.name&&l.setIsRateLimited(!0),(0,d.vV)("chat-page-store:reconnectToInflightResponses","Error reconnecting to inflight response")},onError:this.isErrorRetryable,ff:o})}catch(e){(0,d.vV)("chat-page-store:reconnectToInflightResponses","Error checking inflight responses")}},this.requestLivekitToken=async e=>{let{livekitUrl:t,conversationId:s,ff:n}=e,i=this.get(),r=null===o.sessionStoreState||void 0===o.sessionStoreState?void 0:o.sessionStoreState.getState();try{var a,l,c;let e=await p.hx.livekitCreateToken({body:{conversationId:s,sessionPayload:JSON.stringify({...K({username:null==r||null==(a=r.user)?void 0:a.givenName,customInstructions:i.voiceCustomInstructions,voiceId:i.voiceId,personalityId:i.voicePersonalityId,playbackSpeed:i.voicePlaybackSpeed,ff:n}),enable_vision:(null==(c=i.livekitRoom)||null==(l=c.localParticipant)?void 0:l.isScreenShareEnabled)||!1,turn_detection:{type:"server_vad"}}),requestAgentDispatch:!1,livekitUrl:t}});if(!e.token)throw Error("No livekit token returned");return i.setLivekitToken(e.token),i.setLivekitRequestId(e.requestId||null),{token:e.token,requestId:e.requestId||null}}catch(e){throw(0,d.vV)("chat-page-store:requestLivekitToken","Failed to get livekit token"),e}},this.enterVoiceMode=async e=>{var t,s;let{livekitUrl:o,ff:n}=e,i=this.get();if(this.voiceModeTimeoutId&&(clearTimeout(this.voiceModeTimeoutId),this.setVoiceModeTimeoutId(null)),"voice"===i.conversationMode&&"disconnected"!==i.voiceConnectionStatus)throw(0,d.vV)("chat-page-store:enterVoiceMode","Already in voice mode"),Error("Already in voice mode");let r=(0,M.A)();this.setCurrentVoiceSessionId(r),this.setVoiceSessionConversationId(i.conversationId||"no-conversation-id"),u.startVoiceSession({sessionId:r,voiceId:i.voiceId,personalityId:i.voicePersonalityId,customInstructions:i.voiceCustomInstructions,playbackSpeed:i.voicePlaybackSpeed,enableSearch:H({personalityId:i.voicePersonalityId,voiceId:i.voiceId,ff:n}),enableVision:!!(null==(s=i.livekitRoom)||null==(t=s.localParticipant)?void 0:t.isScreenShareEnabled)}),this.setConversationMode("voice"),this.setVoiceConnectionStatus("connecting"),(0,C.He)("silent");try{let e=new C.Wv({publishDefaults:{screenShareEncoding:{maxBitrate:35e5,maxFramerate:1}}});this.setLivekitRoom(e);let{token:t,requestId:s}=await this.requestLivekitToken({livekitUrl:o,conversationId:i.conversationId,ff:n});u.trackLivekitTokenReceived(s),e.prepareConnection(o,t).catch(e=>{(0,d.vV)("chat-page-store:enterVoiceMode",e.message),u.trackError("connection_prepare_failed",e.message)});let r=null,a=new Promise(e=>{r=e});e.on(C.u9.Disconnected,async()=>{await this.exitVoiceMode("connection_lost")}),e.on(C.u9.Reconnecting,()=>{this.setVoiceConnectionStatus("reconnecting")}),e.on(C.u9.Reconnected,()=>{this.setVoiceConnectionStatus("connected")}),e.on(C.u9.LocalTrackSubscribed,e=>{e.source===C.CC.Source.Microphone&&u.trackLocalTrackSubscribed()}),e.on(C.u9.ParticipantDisconnected,async()=>(u.trackError("participant_disconnected","Participant disconnected"),this.exitVoiceMode("participant_disconnected").finally(()=>{_.oR.error("Voice connection lost")}))),e.on(C.u9.DataReceived,(e,t,s,o)=>{let n=new TextDecoder().decode(e);if("realtime_server_events"===o){let e=JSON.parse(n);switch(e.type){case"ping":return this.handleVoiceConnectionPing();case"conversation.created":var i;if(u.trackConversationCreated({conversationId:null==e||null==(i=e.conversation)?void 0:i.id,connectionState:this.get().voiceConnectionStatus}),["connecting","reconnecting","connected"].includes(this.get().voiceConnectionStatus))return this.setVoiceConnectionStatus("ready"),r&&r(),this.handleConversationCreated(e);break;case"conversation.item.created":return this.handleConversationItemCreated(e);case"response.created":return this.handleAssistantVoiceResponseCreated(e);case"response.audio_transcript.delta":return this.handleAssistantVoiceResponseTranscriptDelta(e);case"response.search.result":return this.handleVoiceResponseSearchResult(e);case"response.grok.output":return this.handleVoiceGrokOutput(e)}}}),e.localParticipant.on(C.YI.LocalTrackPublished,e=>{if(e.source===C.CC.Source.ScreenShare)return u.trackScreenShareStart(),i.sendVoiceSettingsUpdate({voiceId:i.voiceId,voicePersonalityId:i.voicePersonalityId,voiceCustomInstructions:i.voiceCustomInstructions,voicePlaybackSpeed:i.voicePlaybackSpeed,ff:n})}),e.localParticipant.on(C.YI.LocalTrackUnpublished,e=>{if(e.source===C.CC.Source.ScreenShare)return u.trackScreenShareEnd(),i.sendVoiceSettingsUpdate({voiceId:i.voiceId,voicePersonalityId:i.voicePersonalityId,voiceCustomInstructions:i.voiceCustomInstructions,voicePlaybackSpeed:i.voicePlaybackSpeed,ff:n})}),await e.connect(o,t).then(()=>this.setVoiceConnectionStatus("connected")),await e.localParticipant.setMicrophoneEnabled(!0,{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}).catch(e=>{throw(0,d.vV)("chat-page-store:enterVoiceMode",e.message),u.trackError("microphone_enable_failed",e.message),Error("mic-permission-denied")});let l=new Promise((e,t)=>{this.setVoiceModeTimeoutId(setTimeout(()=>{(0,d.vV)("chat-page-store:enterVoiceMode","Connection ready timeout after 10 seconds"),t(Error("Voice connection ready timeout after 10 seconds"))},1e4))});try{await Promise.race([a,l]),this.get().voiceModeTimeoutId&&(clearTimeout(this.get().voiceModeTimeoutId),this.setVoiceModeTimeoutId(null))}catch(e){throw this.get().voiceModeTimeoutId&&(clearTimeout(this.get().voiceModeTimeoutId),this.setVoiceModeTimeoutId(null)),u.trackError("enter_voice_mode_timeout","Connection ready timeout after 10 seconds"),await this.exitVoiceMode("connection_timeout"),e}}catch(s){let e=s.message||"Unknown error",t="connection_error";throw(null==e?void 0:e.includes("Permission denied"))||(null==e?void 0:e.includes("NotAllowedError"))||"mic-permission-denied"===e?(e="mic-permission-denied",t="mic_permission_denied"):((null==e?void 0:e.includes("Rate limit exceeded"))||(null==e?void 0:e.includes("429")))&&(e="rate-limit-exceeded",t="rate_limit_exceeded"),(0,d.vV)("chat-page-store:enterVoiceMode",(null==s?void 0:s.message)||e),u.trackError("enter_voice_mode_failed",(null==s?void 0:s.message)||e),await this.exitVoiceMode(t),Error(e)}},this.exitVoiceMode=async e=>{let t=this.get();if("disconnected"!==t.voiceConnectionStatus){if("disconnecting"===t.voiceConnectionStatus&&this.exitVoiceModePromise)return this.exitVoiceModePromise;this.exitVoiceModePromise=this.performExitVoiceMode(e);try{await this.exitVoiceModePromise}finally{this.exitVoiceModePromise=null}}},this.performExitVoiceMode=async e=>{let t=this.get(),s=v.w1.getState();if(t.setVoiceConnectionStatus("disconnecting"),t.currentVoiceSessionId&&(u.endVoiceSession(e),this.setCurrentVoiceSessionId(null)),t.voiceModeTimeoutId&&(clearTimeout(t.voiceModeTimeoutId),this.setVoiceModeTimeoutId(null)),t.streamedMessageId){let e=f.A3.getState(),s=e.byId[t.streamedMessageId];if(!s)return void(0,d.vV)("chat-page-store:performExitVoiceMode","Streamed message not found");let o=s.responseId,n=s.inflightResponseId||(0,M.A)();e.upsertResponse({...s,state:"closed",partial:!0,responseId:n}),this.setStreamedMessageId(void 0),this.setOptimisticMessageId(void 0),this.setLastMessageId(n),e.removeResponse(o)}if(t.livekitRoom){var o;await (null==(o=t.livekitRoom.localParticipant)?void 0:o.publishData(new TextEncoder().encode(""),{topic:"disconnect"}).catch(e=>{(0,d.vV)("chat-page-store:exitVoiceMode",e.message),u.trackError("disconnect_data_publish_failed",e.message)})),await t.livekitRoom.disconnect()}t.optimisticConversationId&&(s.removeConversation(t.optimisticConversationId),this.setOptimisticConversationId(void 0),s.removeAbortControllerById(t.optimisticConversationId)),this.setLivekitRoom(null),this.setLivekitToken(null),this.setLivekitRequestId(null),this.setVoiceSessionConversationId(null),this.setVoiceConnectionStatus("disconnected"),this.setConversationMode("chat")},this.toggleScreenSharing=async()=>{var e;let t=this.get();if(!(null==t?void 0:t.livekitRoom)||!(null==t||null==(e=t.livekitRoom)?void 0:e.localParticipant)||"ready"!==t.voiceConnectionStatus)throw(0,d.vV)("chat-page-store:startScreenShare","Voice connection not ready"),Error("Voice connection not ready");let s=t.livekitRoom.localParticipant.isScreenShareEnabled;try{await t.livekitRoom.localParticipant.setScreenShareEnabled(!s,{audio:!1,video:!0,selfBrowserSurface:"exclude",surfaceSwitching:"include"})}catch(e){throw(0,d.vV)("chat-page-store:toggleScreenSharing",(null==e?void 0:e.message)||"Failed to toggle screen share"),u.trackError("screen_share_toggle_failed",(null==e?void 0:e.message)||"Failed to toggle screen share"),e}},this.sendVoiceSettingsUpdate=async e=>{var t,s,n;let{voiceId:i,voicePersonalityId:r,voiceCustomInstructions:a,voicePlaybackSpeed:l,ff:c}=e,h=this.get();if(!h.livekitRoom||"ready"!==h.voiceConnectionStatus)throw(0,d.vV)("chat-page-store:sendVoiceSessionUpdate","Voice connection not ready or disconnected"),Error("Voice connection not ready or disconnected");let p={voiceId:h.voiceId,voicePersonalityId:h.voicePersonalityId,voiceCustomInstructions:h.voiceCustomInstructions,playbackSpeed:h.voicePlaybackSpeed};(p.voicePersonalityId!==r||p.voiceCustomInstructions!==a)&&u.trackPersonalityChange({fromPersonality:p.voicePersonalityId,toPersonality:r,fromCustomInstructions:p.voiceCustomInstructions,toCustomInstructions:a}),p.voiceId!==i&&u.trackVoiceChange({fromVoice:p.voiceId,toVoice:i}),p.playbackSpeed!==l&&u.trackPlaybackSpeedChange({fromSpeed:p.playbackSpeed,toSpeed:l}),this.setVoiceId(i),this.setVoicePersonalityId(r),this.setVoiceCustomInstructions(a),this.setVoicePlaybackSpeed(l);let m=null===o.sessionStoreState||void 0===o.sessionStoreState?void 0:o.sessionStoreState.getState(),v={...K({username:null==m||null==(t=m.user)?void 0:t.givenName,voiceId:i,personalityId:r,customInstructions:a,playbackSpeed:l,ff:c}),enable_vision:(null==(n=h.livekitRoom)||null==(s=n.localParticipant)?void 0:s.isScreenShareEnabled)||!1};return h.livekitRoom.localParticipant.publishData(new TextEncoder().encode(JSON.stringify({type:"session.update",session:v})),{topic:"realtime_client_event"}).catch(e=>{throw(0,d.vV)("chat-page-store:sendVoiceSettingsUpdate",e.message),u.trackError("voice_settings_update_failed",e.message),this.setVoiceId(p.voiceId),this.setVoicePersonalityId(p.voicePersonalityId),this.setVoiceCustomInstructions(p.voiceCustomInstructions),this.setVoicePlaybackSpeed(p.playbackSpeed),Error("Failed to send voice settings update")})},this.sendVoiceManualMessage=async e=>{let{message:t}=e,s=this.get();if(!s.livekitRoom||"ready"!==s.voiceConnectionStatus)throw(0,d.vV)("chat-page-store:sendVoiceManualMessage","Voice connection not ready"),Error("Voice connection not ready");return u.trackManualMessage(),s.livekitRoom.localParticipant.publishData(new TextEncoder().encode(t),{topic:"grok.chat"}).catch(e=>{throw(0,d.vV)("chat-page-store:sendVoiceManualMessage",e.message),u.trackError("manual_message_failed",e.message),Error("Failed to send voice message")})},this.handleVoiceConnectionPing=()=>{let e=this.get();return e.livekitRoom?e.livekitRoom.localParticipant.publishData(new TextEncoder().encode(JSON.stringify({timestamp:Date.now()})),{topic:"grok.ping"}):void(0,d.vV)("chat-page-store:handleVoiceConnectionPing","No livekit room available")},this.handleConversationCreated=e=>{let{conversation:t}=e,s=this.get(),o=v.w1.getState();if(!s.conversationId&&s.optimisticConversationId){if(!(null==t?void 0:t.id))return(0,d.vV)("chat-page-store:handleConversationCreated","Missing conversation id"),this.exitVoiceMode();let e=o.byId[s.optimisticConversationId];if(!e)return(0,d.vV)("chat-page-store:handleConversationCreated","Optimistic conversation not found"),this.exitVoiceMode();o.removeConversation(s.optimisticConversationId),o.removeAbortControllerById(s.optimisticConversationId);let n={...e,conversationId:t.id,temporary:!1};o.upsertAndCacheConversation(n);let i=new AbortController;o.idsertAbortControllerById(i,t.id),this.setOptimisticConversationId(t.id),this.setVoiceSessionConversationId(t.id)}else if(!s.conversationId&&!s.optimisticConversationId){if(!(null==t?void 0:t.id))return(0,d.vV)("chat-page-store:handleConversationCreated","Missing conversation id"),this.exitVoiceMode();let e={...(0,v.b2)({conversationId:t.id,temporary:!1}),mediaTypes:["audio"]};o.upsertAndCacheConversation(e),this.setOptimisticConversationId(t.id);let s=new AbortController;o.idsertAbortControllerById(s,t.id),this.setVoiceSessionConversationId(t.id)}},this.handleConversationItemCreated=e=>{var t,s,o,n,i,r,a,l;let{item:c}=e;if(!c||!c.id)return void(0,d.vV)("chat-page-store:handleConversationItemCreated","Missing item or item.id");if("user"!==c.role||"completed"!==c.status||!(null==(s=c.content)||null==(t=s[0])?void 0:t.text)&&!(null==(n=c.content)||null==(o=n[0])?void 0:o.transcript))return;u.trackUserTurn();let h=this.get(),p=f.A3.getState(),m=v.w1.getState(),g=h.conversationId;if(!h.conversationId&&h.optimisticConversationId){let e=m.byId[h.optimisticConversationId];if(!e)return(0,d.vV)("chat-page-store:handleConversationItemCreated","Optimistic conversation not found"),this.exitVoiceMode();let t={...e,temporary:!1,state:"closed"};g=t.conversationId,m.upsertAndCacheConversation(t),h.set({optimisticConversationId:void 0,conversationId:t.conversationId}),p.idsertNodesByConversationId([],t.conversationId)}else if(!h.conversationId||!h.lastMessageId)return void(0,d.vV)("chat-page-store:handleConversationItemCreated","Missing conversationId or lastMessageId");let I=p.byId[c.id];if(I)return void p.upsertResponse({...I,message:(null==(a=c.content)?void 0:a[0].text)||(null==(l=c.content)?void 0:l[0].transcript)||""});let y=h.lastMessageId;if(h.streamedMessageId){let e=f.A3.getState(),t=e.byId[h.streamedMessageId];if(!t)return(0,d.vV)("chat-page-store:handleConversationItemCreated","Streamed message not found"),this.exitVoiceMode();let s=t.responseId,o=t.inflightResponseId||(0,M.A)();y=o,e.upsertResponse({...t,state:"closed",partial:!0,responseId:o,inflightResponseId:void 0}),this.setStreamedMessageId(void 0),this.setOptimisticMessageId(void 0),this.setLastMessageId(o),e.removeResponse(s)}p.createVoiceUserMessage({userResponseId:c.id,conversationId:g,parentResponseId:y,message:(null==(i=c.content)?void 0:i[0].text)||(null==(r=c.content)?void 0:r[0].transcript)||"",onUserResponse:e=>{h.setLastMessageId(e.responseId)},onOptimisticModelResponse:e=>{h.setStreamedMessageId(e.responseId)}})},this.handleAssistantVoiceResponseCreated=e=>{let{response:t}=e;if(!(null==t?void 0:t.id))return void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseCreated","Missing response id");let s=this.get(),o=f.A3.getState();if(!s.streamedMessageId)return;let n=o.byId[s.streamedMessageId];return n&&(null==n?void 0:n.parentResponseId)?o.byId[n.parentResponseId]?void(n.inflightResponseId?o.upsertResponse({...n,message:"",inflightResponseId:t.id,state:"streaming"}):(o.upsertResponse({...n,inflightResponseId:t.id,state:"streaming"}),s.setStreamedMessageId(n.responseId))):void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseCreated","Missing parent response"):void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseCreated","Missing streaming response or parent response id")},this.handleAssistantVoiceResponseTranscriptDelta=e=>{let{response_id:t,delta:s}=e;if(!t||!s)return void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseTranscriptDelta","Missing response_id or delta");let o=f.A3.getState(),n=this.get();if(!n.conversationId)return void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseTranscriptDelta","Missing conversationId");let i=o.byConversationId[n.conversationId];if(!i)return void(0,d.vV)("chat-page-store:handleAssistantVoiceResponseTranscriptDelta","Missing conversation responses");let r=i.find(e=>e.inflightResponseId===t);r&&"streaming"===r.state&&o.upsertResponse({...r,message:r.message+s})},this.handleVoiceGrokOutput=e=>{let{response_id:t,follow_ups:s}=e;if(!t)return void(0,d.vV)("chat-page-store:handleVoiceGrokOutput","Missing response_id");let o=f.A3.getState(),n=this.get();if(!n.conversationId)return void(0,d.vV)("chat-page-store:handleVoiceGrokOutput","Missing conversationId");let i=o.byConversationId[n.conversationId];if(!i)return void(0,d.vV)("chat-page-store:handleVoiceGrokOutput","Missing conversation responses");let r=i.find(e=>e.inflightResponseId===t);r&&(u.trackAssistantTurn(),o.upsertResponse({...r,state:"closed",partial:!1,responseId:t,suggestions:s,inflightResponseId:void 0}),this.setStreamedMessageId(void 0),this.setOptimisticMessageId(void 0),this.setLastMessageId(t),o.removeResponse(r.responseId))},this.handleVoiceResponseSearchResult=e=>{let{response_id:t,x_posts:s,web_results:o}=e;if(!t)return void(0,d.vV)("chat-page-store:handleVoiceResponseSearchResult","Missing response_id");if(!(null==s?void 0:s.length)&&!(null==o?void 0:o.length))return;let n=this.get(),i=f.A3.getState();if(!n.conversationId)return void(0,d.vV)("chat-page-store:handleVoiceResponseSearchResult","Missing conversationId");let r=i.byConversationId[n.conversationId];if(!r)return void(0,d.vV)("chat-page-store:handleVoiceResponseSearchResult","Missing conversation responses");let a=i.byId[t]||r.find(e=>e.inflightResponseId===t);if(!a)return void(0,d.vV)("chat-page-store:handleVoiceResponseSearchResult","Missing response");let l=(null==s?void 0:s.map(e=>({username:e.userhandle,name:e.name,text:e.text,createTime:e.create_time,profileImageUrl:e.profile_image_url,postId:e.post_id,viewCount:e.view_count,citationId:e.post_id})))||[],c=(null==o?void 0:o.map(e=>({url:e.url,title:e.title,preview:e.snippet})))||[],u=(null==l?void 0:l.length)?[...a.xposts||[],...l]:a.xposts,h=(null==c?void 0:c.length)?[...a.webSearchResults||[],...c]:a.webSearchResults;i.upsertResponse({...a,xposts:u,xpostIds:w().compact(null==u?void 0:u.map(e=>e.postId)),webSearchResults:h}),l.length&&!n.sidePanelContent?n.setSidePanelContent({type:"xPosts",data:u}):c.length&&!n.sidePanelContent&&n.setSidePanelContent({type:"webSearchResults",data:{webSearchResults:h}})},this.setShowStreamingIndicator=(0,h.kp)(this.set,"showStreamingIndicator"),this.abortStream=(e,t,s,o)=>{let n=f.A3.getState(),i=o?o.getState():this.get(),r=this.get();return n.abortStream(e,t,s).then(t=>{r.conversationId===e&&(i.setLastMessageId(t),i.setStreamedMessageId(t))}).catch(t=>{if(r.conversationId===e)throw i.setStreamedMessageId(void 0),t}).finally(()=>{t&&n.updateResponse(t,{experimentIds:void 0})})}}}let Q=(0,P.v)()((0,x.eh)((0,x.Zr)((e,t)=>new G(e,t),{name:"chat-preferences",partialize:e=>({outputMode:e.outputMode,activeModelId:e.activeModelId,selectedPersonalityId:e.selectedPersonalityId,customPersonality:e.customPersonality,quotedText:e.quotedText,defaultAnonModelId:e.defaultAnonModelId,defaultFreeModelId:e.defaultFreeModelId,defaultProModelId:e.defaultProModelId,voiceId:e.voiceId,voicePersonalityId:e.voicePersonalityId,voiceCustomInstructions:e.voiceCustomInstructions,voicePlaybackSpeed:e.voicePlaybackSpeed,modelMode:e.modelMode}),version:2})));function W(e,t){switch(t){case"deepsearch":case"deepersearch":return{imageGen:void 0,webSearch:void 0,xSearch:void 0,xMediaSearch:void 0,trendsSearch:void 0,xPostAnalyze:void 0,videoGen:void 0,audioGen:void 0}}switch(e){case"modelOnly":return{imageGen:!1,webSearch:!1,xSearch:!1,xMediaSearch:!1,trendsSearch:!1,xPostAnalyze:!1,videoGen:void 0,audioGen:void 0};case"noSearch":return{imageGen:void 0,webSearch:!1,xSearch:!1,xMediaSearch:!1,trendsSearch:!1,xPostAnalyze:!1,videoGen:void 0,audioGen:void 0};default:return{imageGen:void 0,webSearch:void 0,xSearch:void 0,xMediaSearch:void 0,trendsSearch:void 0,xPostAnalyze:void 0,videoGen:void 0,audioGen:void 0}}}function H(e){var t,s,o,n,i,r,a,d,l;let{personalityId:c,voiceId:u,ff:h}=e,p=Array.isArray(null==h||null==(s=h.VOICE_MODE_CONFIG)||null==(t=s.value)?void 0:t.personalities)?null==h||null==(n=h.VOICE_MODE_CONFIG)||null==(o=n.value)?void 0:o.personalities:[],m=(Array.isArray(null==h||null==(r=h.VOICE_MODE_CONFIG)||null==(i=r.value)?void 0:i.voices)?null==h||null==(d=h.VOICE_MODE_CONFIG)||null==(a=d.value)?void 0:a.voices:[]).find(e=>e.id===u),v=!1;return!c||(null==m?void 0:m.disablePersonalities)||(v=(null==(l=p.find(e=>e.id===c&&e.enableSearch))?void 0:l.enableSearch)||!1),v}function K(e){var t,s,o,n;let{username:i,voiceId:r,personalityId:a,customInstructions:d,playbackSpeed:l,ff:c}=e,u=(Array.isArray(null==c||null==(s=c.VOICE_MODE_CONFIG)||null==(t=s.value)?void 0:t.voices)?null==c||null==(n=c.VOICE_MODE_CONFIG)||null==(o=n.value)?void 0:o.voices:[]).find(e=>e.id===r),h=null;!a||(null==u?void 0:u.disablePersonalities)||(h=a);let p=null;return!d||(null==u?void 0:u.disablePersonalities)||(p=d),{instructions:function(e){var t,s,o,n,i,r,a,d,l,c;let{username:u,customInstructions:h,voiceId:p,personalityId:m,ff:v}=e,g=Array.isArray(null==v||null==(s=v.VOICE_MODE_CONFIG)||null==(t=s.value)?void 0:t.voices)?null==v||null==(n=v.VOICE_MODE_CONFIG)||null==(o=n.value)?void 0:o.voices:[],I=Array.isArray(null==v||null==(r=v.VOICE_MODE_CONFIG)||null==(i=r.value)?void 0:i.personalities)?null==v||null==(d=v.VOICE_MODE_CONFIG)||null==(a=d.value)?void 0:a.personalities:[],f=(null==g||null==(l=g.find(e=>e.id===p))?void 0:l.prompt)||"Reminder: You do not need to introduce yourself unless the user asks for your name. You are Grok, a smart and helpful AI assistant created by xAI. You have a PLEASANT female voice. You're a helpful AI assistant that helps get things done. Never use commands and write your answer as if it was a transcript of an audio conversation. You are using your voice to speak aloud, so keep your responses brief.",y=(null==I||null==(c=I.find(e=>e.id===m))?void 0:c.prompt)||"";return"".concat(f," ").concat(m?y:""," ").concat(u?"You are speaking with ".concat(u,". Do not repeat the name unless necessary."):""," ").concat(h||"")}({username:i,customInstructions:p,voiceId:r,personalityId:h,ff:c}),voice:r,personality:h,enable_search:H({personalityId:a,voiceId:r,ff:c}),playback_speed:l}}function $(e,t,s){var o,n;if(e)return e;let i=g.V.getState().modelById[s];return((null==i||null==(o=i.tags)?void 0:o.includes("think"))||"think"!==t)&&((null==i||null==(n=i.tags)?void 0:n.includes("deepsearch"))||"deepsearch"!==t&&"deepersearch"!==t)?t:"none"}function X(e,t,s,o){let n=o.getState(),i=(s[e]||[]).filter(e=>e.threadParentId&&e.threadParentId===t).sort((e,t)=>new Date(e.createTime).getTime()-new Date(t.createTime).getTime());return n.lastMessageId?n.lastMessageId:i.length>0?i[i.length-1].responseId:t}(0,h.lB)(Q,"conversationId","optimisticConversationId",()=>void 0),Q.subscribe((e,t)=>{if(e.conversationId!==t.conversationId&&void 0!==t.conversationId){let{setSidePanelContent:e}=Q.getState();e(void 0)}}),(0,h.lB)(Q,"conversationId","lastMessageId",e=>{if(!e)return}),(0,h.lB)(Q,"conversationId","streamedMessageId",e=>{if(!e)return}),(0,h.lB)(Q,"conversationId","isRateLimited",()=>!1),(0,h.lB)(Q,"conversationId","isUnauthenticated",()=>!1),(0,h.lB)(Q,"conversationId","hasDismissedDisclaimer",()=>!1),(0,h.lB)(Q,"activeModelId","isRateLimited",()=>!1),(0,h.lB)(Q,"reasoningMode","isRateLimited",()=>!1),y.XO.subscribe((e,t)=>{let{setOptimisticConversationId:s,setConversationId:o,setSurvey:n}=Q.getState();if("main"===e.route.page&&"main"!==t.route.page){let{setIsIncognito:e}=S.C$.getState();e(!1),"chat"===t.route.page&&(s(void 0),o(void 0),n(void 0))}"chat"===e.route.page&&"chat"===t.route.page&&e.route.conversationId!==t.route.conversationId&&n(void 0),"main"!==e.route.page&&(F=!1)}),n.iV.subscribe((e,t)=>{(e.open||t.open)&&(F=!1)}),globalThis.addEventListener("hashchange",()=>{F=!1}),globalThis.document.addEventListener("visibilitychange",()=>{F=!1}),globalThis.addEventListener("blur",function(){F=!1}),Q.subscribe(e=>{"voice"===e.conversationMode&&"disconnecting"!==e.voiceConnectionStatus&&e.voiceSessionConversationId&&("no-conversation-id"===e.voiceSessionConversationId&&e.conversationId||"no-conversation-id"!==e.voiceSessionConversationId&&(e.conversationId&&e.voiceSessionConversationId!==e.conversationId||!e.conversationId&&e.optimisticConversationId!==e.voiceSessionConversationId))&&e.exitVoiceMode("navigation").catch(e=>(0,d.vV)("chat-page-store:handleVoiceModeExit",e))}),!function(e){let t=new k.w("/chat/:chatId").test(window.location.pathname);e.setState({conversationId:t?t.chatId:void 0})}(Q)},41320:(e,t,s)=>{s.d(t,{Di:()=>n,Iu:()=>i});var o=s(88382);function n(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:768,[t,s]=o.useState(void 0);return o.useEffect(()=>{let t=window.matchMedia("(max-width: ".concat(e-1,"px)")),o=()=>{s(window.innerWidth<e)};return t.addEventListener("change",o),s(window.innerWidth<e),()=>t.removeEventListener("change",o)},[e]),!!t}function i(){let e=n();return{isMobileSize:function(){return e},isTouchDevice:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}}}},41739:(e,t,s)=>{s.d(t,{a:()=>l});var o=s(65258),n=s(38541),i=s.n(n),r=s(82509),a=s(17823);class d{constructor(e,t){var s=this;this.set=e,this.get=t,this.drawerOpen=!1,this.menuFixed=!0,this.menuHidden=!0,this.tabByConversationId={},this.inEditId=void 0,this.upsertConversationAsTab=function(e,t){let o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=s.get(),r=t?n.tabByConversationId[t]:void 0;r&&t&&n.removeTab(t);let a=r||n.tabByConversationId[e.conversationId];if(a)return void n.upsertTab({isTemporary:e.temporary,title:e.title,index:a.index,conversationId:e.conversationId,isPreserved:a.isPreserved});n.setTabByConversationId({...i().mapValues(n.tabByConversationId,e=>({...e,index:e.index+1})),[e.conversationId]:{isTemporary:e.temporary,title:e.title,index:0,conversationId:e.conversationId,isPreserved:o}})},this.upsertTab=(0,o.el)(this.set,"tabByConversationId","conversationId"),this.removeTab=(0,o.TF)(this.set,"tabByConversationId"),this.appendTabByConversationId=(0,o.BC)(this.set,"tabByConversationId","conversationId"),this.setTabByConversationId=(0,o.kp)(this.set,"tabByConversationId"),this.setDrawerOpen=(0,o.kp)(this.set,"drawerOpen"),this.toggleMenuFixed=(0,o.L$)(this.set,"menuFixed"),this.setMenuFixed=(0,o.kp)(this.set,"menuFixed"),this.setMenuHidden=(0,o.kp)(this.set,"menuHidden"),this.setInEditId=(0,o.kp)(this.set,"inEditId")}}let l=(0,r.v)()((0,a.eh)((0,a.Zr)((e,t)=>new d(e,t),{name:"active-chat-tabs",storage:(0,a.KU)(()=>localStorage),partialize:e=>({tabByConversationId:i().omitBy(e.tabByConversationId,e=>!e.isTemporary&&e.isPreserved)}),version:2})))},44347:(e,t,s)=>{s.d(t,{C$:()=>f,DC:()=>h,K2:()=>c,Qy:()=>p});var o=s(65258),n=s(95158),i=s(38541),r=s.n(i),a=s(6132),d=s(82509),l=s(17823);let c={web_search:"web_search",google_web_search:"google_web_search",bing_web_search:"bing_web_search",web_search_with_snippets:"web_search_with_snippets",browse_page_with_js:"browse_page_with_js",browse_page_no_js:"browse_page_no_js",code_execution_training_parity:"code_execution_training_parity",get_x_user_handle:"get_x_user_handle",get_x_user_profile_pic_description:"get_x_user_profile_pic_description",x_post_lookup:"x_post_lookup",x_search:"x_search",x_keyword_search:"x_keyword_search",x_semantic_search:"x_semantic_search",get_top_us_news_from_x_trends:"get_top_us_news_from_x_trends",get_x_user_timeline:"get_x_user_timeline",get_x_bookmarks:"get_x_bookmarks",get_x_liked_posts:"get_x_liked_posts",render_x_posts:"render_x_posts",render_x_users:"render_x_users",render_card:"render_card"},u=a.z.object({model_name:a.z.string().nullish(),system_prompt_name:a.z.string().nullish(),enable_unified_layout:a.z.boolean().nullish(),tools_set:a.z.string().nullish(),system_turn_prompt:a.z.string().nullish(),tool_definition_prompt:a.z.string().nullish()}),h=a.z.object({promptMap:a.z.object({toolUseFc:a.z.string().nullish(),noToolUse:a.z.string().nullish(),toolUseSummarizer:a.z.string().nullish()}).nullish(),modelMap:a.z.object({noToolUse:a.z.string().nullish(),toolUse:a.z.string().nullish(),toolUseSummarizer:a.z.string().nullish(),imageGenModel:a.z.string().nullish(),imageEditModel:a.z.string().nullish()}).nullish(),useSingleModelEverything:a.z.boolean().nullish(),tools:a.z.record(a.z.nativeEnum(c),a.z.boolean()).nullish(),useToolOverrides:a.z.boolean().nullish(),sideBySideParams:u.array().nullish(),useSideBySideParams:a.z.boolean().nullish()});function p(e){let t=Object.values(null!=e?e:{});return!!t&&t.some(e=>"object"==typeof e&&e?Object.values(e).length>0:!e)}a.z.object({displayUserMessageMarkdown:a.z.boolean(),showFollowUpSuggestions:a.z.boolean(),autoWrapLongLinesCode:a.z.boolean(),browserNotificationsEnabled:a.z.boolean(),selectedSystemPromptId:a.z.string().optional(),showConversationPreviews:a.z.boolean(),hideArtifacts:a.z.boolean(),showActiveTabs:a.z.boolean(),disableTypeahead:a.z.boolean(),disableAutoScroll:a.z.boolean(),showGrok3ModeButtons:a.z.boolean(),enableTiptapEditorForQueryBar:a.z.boolean(),useModelModeSelector3:a.z.boolean(),enableStarBackground:a.z.boolean(),isAsyncChat:a.z.boolean()});let m={displayUserMessageMarkdown:!1,showFollowUpSuggestions:!0,autoWrapLongLinesCode:!1,browserNotificationsEnabled:!1,selectedSystemPromptId:void 0,showConversationPreviews:!0,hideArtifacts:!1,showActiveTabs:!0,disableTypeahead:!1,disableAutoScroll:!1,showGrok3ModeButtons:!1,enableTiptapEditorForQueryBar:!0,useModelModeSelector3:!0,enableStarBackground:!0,isAsyncChat:!1},v={excludeFromTraining:!1,allowXPersonalization:!0,preferences:m,enableMemory:!0,allowShareIndexing:!1},g={excludeFromTraining:!0,allowXPersonalization:!1,preferences:m,enableMemory:!1,allowShareIndexing:!1};class I{constructor(e,t){this.set=e,this.get=t,this.isIncognito=!1,this.userSettingsPromise=void 0,this.userSettings=v,this.selectedLanguage=void 0,this.showAgeVerification=!1,this.ageVerificationCallback=void 0,this.modelConfigOverride=void 0,this.modelConfigOverrideByModel={},this.isToolComposer2=void 0,this.sideBySideMode=void 0,this.skipResponseCache=void 0,this.setIsIncognito=(0,o.kp)(this.set,"isIncognito"),this.setUserSettingsPromise=(0,o.kp)(this.set,"userSettingsPromise"),this.setUserSettings=(0,o.kp)(this.set,"userSettings"),this.setSelectedLanguage=(0,o.kp)(this.set,"selectedLanguage"),this.setShowAgeVerification=(0,o.kp)(this.set,"showAgeVerification"),this.setAgeVerificationCallback=(0,o.kp)(this.set,"ageVerificationCallback"),this.setModelConfigOverrideByModel=(0,o.kp)(this.set,"modelConfigOverrideByModel"),this.setIsToolComposer2=(0,o.kp)(this.set,"isToolComposer2"),this.setSideBySideMode=(0,o.kp)(this.set,"sideBySideMode"),this.setSkipResponseCache=(0,o.kp)(this.set,"skipResponseCache"),this.loadFromPrefetch=e=>{let t=this.get();this.setUserSettings(S(e,t.userSettings))},this.initializeGdprUserSettings=()=>n.aK.settingsGetUserSettings().then(e=>{let t=this.get();void 0===e.excludeFromTraining||void 0===e.enableMemory?t.fetchSetUserSettings(g).catch(console.error):t.setUserSettings(S(e,t.userSettings))}),this.initializeEnterpriseUserSettings=()=>n.aK.settingsGetUserSettings().then(e=>{let t=this.get();e.excludeFromTraining?t.setUserSettings(S(e,t.userSettings)):t.fetchSetUserSettings(g).catch(console.error)}),this.fetchGetUserSettings=()=>{let e=this.get();if(e.userSettingsPromise)return e.userSettingsPromise;let t=n.aK.settingsGetUserSettings().then(t=>S(t,e.userSettings));return e.setUserSettingsPromise(t),t.then(e.setUserSettings).catch(console.error),t},this.fetchSetUserSettings=e=>{let t=this.get();t.setUserSettings({...t.userSettings,...e});let s=n.aK.settingsSetUserSettings({body:e}).then(e=>S(e,this.get().userSettings));return t.setUserSettingsPromise(s),s.then(t.setUserSettings).catch(e=>{console.error(e)}),s},this.fetchSetPreference=(e,t)=>{let s=this.get();return s.fetchSetUserSettings({...s.userSettings,preferences:{...s.userSettings.preferences,[e]:t}})}}}let f=(0,d.v)()((0,l.eh)((0,l.Zr)((e,t)=>new I(e,t),{name:"settings-store",partialize:e=>({modelConfigOverrideByModel:e.modelConfigOverrideByModel,isToolComposer2:e.isToolComposer2,sideBySideMode:e.sideBySideMode,skipResponseCache:e.skipResponseCache}),version:2})));function y(e,t){return a.z.object({displayUserMessageMarkdown:a.z.boolean().catch(e.displayUserMessageMarkdown),showFollowUpSuggestions:a.z.boolean().catch(e.showFollowUpSuggestions),autoWrapLongLinesCode:a.z.boolean().catch(e.autoWrapLongLinesCode),browserNotificationsEnabled:a.z.boolean().catch(e.browserNotificationsEnabled),selectedSystemPromptId:a.z.string().optional().catch(e.selectedSystemPromptId),showConversationPreviews:a.z.boolean().catch(e.showConversationPreviews),hideArtifacts:a.z.boolean().catch(e.hideArtifacts),showActiveTabs:a.z.boolean().catch(e.showActiveTabs),disableTypeahead:a.z.boolean().catch(e.disableTypeahead),disableAutoScroll:a.z.boolean().catch(e.disableAutoScroll),showGrok3ModeButtons:a.z.boolean().catch(e.showGrok3ModeButtons),enableTiptapEditorForQueryBar:a.z.boolean().catch(e.enableTiptapEditorForQueryBar),useModelModeSelector3:a.z.boolean().catch(e.useModelModeSelector3),enableStarBackground:a.z.boolean().catch(e.enableStarBackground),isAsyncChat:a.z.boolean().catch(e.isAsyncChat)}).catch(e).parse(t)}function S(e,t){let s=r().omitBy(e,r().isUndefined);return{...t,...s,preferences:y(t.preferences,e.preferences)}}(0,o.CP)(f,"userSettings","user-settings",f.getInitialState().userSettings,function(e){if(!e||"object"!=typeof e)return v;let t=r().omitBy(e,r().isUndefined);return{...v,...t,preferences:{...y(m,e.userSettings),disableTypeahead:!1,showGrok3ModeButtons:!1}}})},44845:(e,t,s)=>{s.d(t,{Ku:()=>i,TM:()=>n,ot:()=>r});var o=s(6132);let n=o.z.union([o.z.literal("none"),o.z.literal("unknown"),o.z.literal("deepsearch"),o.z.literal("deepersearch"),o.z.literal("think")]);function i(e){return"deepersearch"===e?"deeper":"deepsearch"===e?"default":void 0}function r(e){return"deepersearch"===e?"DEEPERSEARCH":"deepsearch"===e?"DEEPSEARCH":"think"===e?"REASONING":"DEFAULT"}},48304:(e,t,s)=>{s.d(t,{K$:()=>i,Mh:()=>n,XM:()=>o});class o extends Error{constructor(e,t){var s,n;super(e),this.conversationId=t,this.name="ConversationDoesNotExistError",this.name="ConversationDoesNotExistError",null==(s=(n=Error).captureStackTrace)||s.call(n,this,o)}}class n extends Error{constructor(e,t){var s,o;super(e),this.conversationId=t,this.name="ConversationNotOwnedByUserError",this.name="ConversationNotOwnedByUserError",null==(s=(o=Error).captureStackTrace)||s.call(o,this,n)}}class i extends Error{constructor(e,t,s){var o,n;super(e),this.conversationId=t,this.shareLinkPath=s,this.name="ConversationNotOwnedByUserButIsSharedError",this.name="ConversationNotOwnedByUserButIsSharedError",null==(o=(n=Error).captureStackTrace)||o.call(n,this,i)}}},48992:(e,t,s)=>{s.d(t,{Cg:()=>l,Mb:()=>c,Po:()=>h,Wm:()=>function e(t,s){let o=t[s];if(!o)return s;let n=o[o.length-1];return n&&n.responseId?e(t,n.responseId):s},d7:()=>a,fK:()=>r,iM:()=>v,m$:()=>d,oN:()=>m,t$:()=>p,zp:()=>u});var o=s(38541),n=s.n(o),i=s(17703);function r(e){return"".concat(e.responseId,":").concat(e.state)}function a(e,t,s){let o=n().keyBy(t,"responseId"),i=o[e];if(!i)return[];let r=[i],a=i.parentResponseId;for(;a&&(!s||r.length<s);){let e=o[a];if(!e||e.threadParentId)break;r.push(e),a=e.parentResponseId}return r}function d(e,t){let s;for(let o of e)if(t.find(e=>e.responseId===o.responseId))s=o;else break;return s}function l(e,t){let s=[],o=e,n=new Set;for(;o;){if(n.has(o.responseId||"")){(0,i.vV)("conversation-utils:getAncestorIds","Cycle detected in response hierarchy: ".concat(o.responseId));break}n.add(o.responseId||""),s.unshift(o.responseId||"");let e=o.parentResponseId;if(!e)break;o=t[e]}return s}function c(e){let t=e.filter(e=>!e.threadParentId),s=new Set(t.map(e=>e.parentResponseId)),o=t.filter(e=>!s.has(e.responseId));if(0!==o.length)return n().maxBy(o,e=>e.createTime)}function u(e,t,s){if(!s)return!1;for(let o of a(s,t))if(o.responseId&&!e.some(e=>e.responseId===o.responseId))return!0;return!1}function h(e){if(!e||0===e.length)return 0;let t=new Set(e.map(e=>e.parentResponseId).filter(e=>e&&!n().isEmpty(e))),s=e.filter(e=>!t.has(e.responseId)),o=0;for(let t of s)o=Math.max(o,a(t.responseId,e).length);return o}function p(e,t){return t.filter(t=>"threadParentId"in t&&t.threadParentId===e)}function m(e,t){return t.filter(t=>{var s,o;return t.threadParentId===e&&!(null==(s=t.responseId)?void 0:s.startsWith("streaming_in_progress_"))&&!(null==(o=t.responseId)?void 0:o.startsWith("optimistic_"))}).length}function v(e,t){let s=t[e];if(!s)return[];let o=n().uniqBy(s,"responseId");return null==o?void 0:o.filter(e=>e.responseId&&!e.responseId.startsWith("streaming_in_progress")&&!e.responseId.startsWith("optimistic_")&&e.state&&("closed"===e.state||"error"===e.state))}},49972:(e,t,s)=>{s.d(t,{b2:()=>C,w1:()=>b});var o=s(2376),n=s(48304),i=s(17703),r=s(65258),a=s(95158),d=s(94980),l=s(3275),c=s(74995),u=s(6230),h=s(23831),p=s(53915),m=s(3814),v=s(54542),g=s(98451),I=s(97960);function f(e){return{...e,personaId:(0,o._c)(e.systemPromptName),isNew:!1,state:"closed"}}let y=d.A(f);class S{constructor(e,t){this.set=e,this.get=t,this.promiseById={},this.byId={},this.list=[],this.abortControllerById={},this.listPromiseByQuery={},this.nextPageTokenByQuery={},this.upsertConversation=(0,r.el)(this.set,"byId","conversationId"),this.appendConversations=(0,r.BC)(this.set,"byId","conversationId"),this.removeConversation=(0,r.TF)(this.set,"byId"),this.setById=(0,r.kp)(this.set,"byId"),this.idsertConversationPromise=(0,r.q5)(this.set,"promiseById"),this.removeConversationPromise=(0,r.TF)(this.set,"promiseById"),this.setPromiseById=(0,r.kp)(this.set,"promiseById"),this.idsertAbortControllerById=(0,r.q5)(this.set,"abortControllerById"),this.removeAbortControllerById=(0,r.TF)(this.set,"abortControllerById"),this.setListPromiseByQuery=(0,r.kp)(this.set,"listPromiseByQuery"),this.idsertListPromiseByQuery=(0,r.q5)(this.set,"listPromiseByQuery"),this.idsertNextPageTokenByQuery=(0,r.q5)(this.set,"nextPageTokenByQuery"),this.clear=()=>{this.set(b.getInitialState())},this.upsertAndCacheConversation=(e,t)=>{let s=this.get();t&&t in s.byId&&t!==e.conversationId&&(s.removeConversation(t),s.removeConversationPromise(t)),s.upsertConversation(e),s.idsertConversationPromise(Promise.resolve(e),e.conversationId)},this.appendAndCacheConversations=e=>{let t=l.A(c.A("conversationId"),e),s=u.A(e=>Promise.resolve(e),t),{byId:o,promiseById:n}=this.get();this.set({byId:{...o,...t},promiseById:{...n,...s}})},this.fetchCreateConversation=e=>{var t;let s=this.get(),n=I.A3.getState(),r=a.chatApi.chatCreateConversation({body:e}).then(e=>({...e,personaId:(0,o._c)(e.systemPromptName),isNew:!0,state:"closed"})),d=null==(t=e.addResponseRequest)?void 0:t.conversationId;return d&&(s.idsertConversationPromise(r,d),n.nodesByConversationId[d]=[]),r.then(e=>{s.upsertConversation(e),s.idsertConversationPromise(r,e.conversationId),n.nodesByConversationId[e.conversationId]=[]}).catch((0,i.HX)("fetchCreateConversation")),r},this.fetchUpdateConversation=(e,t)=>{let s=this.get(),o=a.chatApi.chatUpdateConversation({conversationId:e,body:t}).then(t=>({...s.byId[t.conversationId]||{conversationId:e,isNew:!1,state:"closed",title:"",starred:!1,createTime:"",modifyTime:"",temporary:!1,mediaTypes:[],workspaces:[],taskResult:{},teamId:""},...t})).then(h.A(s.upsertConversation)),n={...s.byId[e]||{conversationId:e,isNew:!1,state:"closed",title:"",starred:!1,createTime:"",modifyTime:"",temporary:!1,mediaTypes:[],workspaces:[],taskResult:{},teamId:""},...t};return s.upsertConversation(n),s.idsertConversationPromise(Promise.resolve(n),e),o.then(()=>s.idsertConversationPromise(o,e)).catch((0,i.HX)("fetchUpdateConversation")),o},this.fetchForceDeleteConversation=e=>{let t=this.get(),s=a.chatApi.chatDeleteConversation({conversationId:e});return t.removeConversation(e),t.removeConversationPromise(e),t.setListPromiseByQuery(u.A(t=>t.then(t=>t.filter(t=>t.conversation.conversationId!==e)),t.listPromiseByQuery)),s},this.fetchSoftDeleteConversation=e=>{let t=this.get(),s=a.chatApi.chatSoftDeleteConversation({conversationId:e});return t.removeConversation(e),t.removeConversationPromise(e),s},this.fetchGetConversation=e=>{let t=this.get();if(e in t.promiseById&&t.promiseById[e])return t.promiseById[e];let s=a.chatApi.chatGetConversationV2({conversationId:e,includeWorkspaces:!0,includeTaskResult:!0}).then(t=>{if(!t.conversation&&!t.shareLinkPath)throw new n.Mh("Conversation not owned by user",e);if(!t.conversation&&t.shareLinkPath)throw new n.K$("Conversation not owned by user but is shared",e,t.shareLinkPath);if(t.conversation)return f(t.conversation);throw Error("Unhandled error when fetching conversation")}).catch(t=>{if((null==t?void 0:t.status)===404)throw new n.XM("Conversation not found",e);throw t});return t.set(p.A(m.A(["promiseById",e]),s)),s.then(t.upsertConversation).catch(console.error),s},this.fetchGetManyConversations=e=>{let t=this.get(),s={},o=[];if(e.forEach(e=>{e in t.promiseById&&t.promiseById[e]?s[e]=t.promiseById[e]:o.push(e)}),0===o.length)return Promise.all(Object.values(s));let n=o.length>0?a.chatApi.chatGetConversations({conversationIds:o,includeWorkspaces:!0,includeTaskResult:!0}).then(e=>{let{conversations:t}=e;return t||[]}).then(y):Promise.resolve([]);return n.then(e=>{e.forEach(e=>{let s=Promise.resolve(e);t.idsertConversationPromise(s,e.conversationId)}),t.appendConversations(e)}).catch(console.error),Promise.all([...Object.values(s),n.then(e=>e||[])]).then(e=>e.flat())},this.fetchListConversations=(e,t)=>{let s=this.get(),o=JSON.stringify(function e(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(e);let s=Object.keys(t).sort(),o={};for(let n of s)o[n]=e(t[n]);return o}(v.A(e=>!!e,e||{})),null,void 0);if(!t&&o in s.listPromiseByQuery&&s.listPromiseByQuery[o])return s.listPromiseByQuery[o];let n=t?s.nextPageTokenByQuery[o]:void 0,i=a.chatApi.chatListConversations({pageSize:"60",pageToken:n,...e}).then(e=>{let{conversations:t,textSearchMatches:n,nextPageToken:i}=e;return(i&&s.idsertNextPageTokenByQuery(i,o),null==n?void 0:n.length)?n.map(e=>{if(e.conversation)return{...e,conversation:f(e.conversation)}}):(null==t?void 0:t.length)?t.map(e=>({conversation:f(e)})):[]}).then(e=>e.filter(e=>!!e)).then(h.A(e=>{s.appendConversations(e.map(e=>e.conversation)),s.setPromiseById(u.A(e=>Promise.resolve(e.conversation),l.A(e=>e.conversation.conversationId,e)))}));if(t){let e=s.listPromiseByQuery[o];if(e)return Promise.all([e,i]).then(g.A);s.idsertListPromiseByQuery(i,o)}else s.idsertListPromiseByQuery(i,o);return i},this.fetchSoftDeleteAllConversations=()=>(this.setById({}),this.setPromiseById({}),a.chatApi.chatSoftDeleteAllConversations())}}let b=(0,r.y$)(S,"useConversationStore");function C(e){let t=new Date().toISOString();return{title:"New conversation",createTime:t,modifyTime:t,starred:!1,temporary:!1,isNew:!0,state:"optimistic",mediaTypes:[],workspaces:[],taskResult:{},teamId:"",...e}}(0,r.lB)(b,"byId","list",Object.values)},56096:(e,t,s)=>{s.d(t,{x:()=>i});var o=s(65258);class n{constructor(e,t){this.set=e,this.get=t}}let i=(0,o.y$)(n,"useSubscriptionsStore")},56691:(e,t,s)=>{s.d(t,{$n:()=>c,gx:()=>u,ru:()=>l});var o=s(79342),n=s(7287),i=s(17338),r=s(88382),a=s(61312),d=s(61884);let l=(0,i.F)(["inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer","focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:opacity-60 disabled:cursor-not-allowed","transition-colors duration-100","[&_svg]:shrink-0","select-none"],{variants:{variant:{filled:"bg-button-filled text-fg-invert hover:bg-button-filled-hover disabled:hover:bg-button-filled",filledSecondary:"bg-surface-l2 text-fg-secondary hover:bg-surface-l4-hover dark:hover:bg-surface-l3 border border-border-l1 disabled:hover:bg-surface-l2 dark:disabled:hover:bg-surface-l2",outline:"border border-border-l2 text-fg-primary hover:bg-button-ghost-hover [&_svg]:hover:text-fg-primary disabled:hover:bg-transparent",ghost:"text-fg-primary hover:bg-button-ghost-hover disabled:hover:bg-transparent border border-transparent",ghostSecondary:"text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&_svg]:hover:text-fg-primary",text:"text-fg-primary bg-transparent hover:text-fg-secondary disabled:hover:text-fg-primary",textSecondary:"text-secondary bg-transparent hover:text-primary disabled:hover:text-fg-secondary",sticky:"text-fg-secondary hover:text-fg-primary disabled:hover:text-fg-secondary bg-surface-l1 dark:bg-surface-l2 dark:hover:bg-surface-l3 hover:bg-surface-l4-hover disabled:hover:bg-surface-l1 dark:disabled:hover:bg-surface-l2",none:"",primary:"bg-button-primary text-background hover:bg-button-primary-hover",secondary:"bg-button-secondary text-primary hover:bg-button-secondary-hover",accent:"bg-sunset/90 text-ivory hover:bg-sunset",card:"ring-1 ring-inset ring-toggle-border bg-card hover:bg-card-hover text-primary",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",link:"text-primary underline-offset-4 hover:underline"},size:{xxs:"h-5 rounded-lg px-1.5 text-[10px]",xs:"h-6 rounded-lg px-2.5 text-xs",sm:"h-8 rounded-xl px-3 text-xs",md:"h-10 rounded-xl px-3.5 py-1.5 text-sm",lg:"h-12 rounded-2xl px-5",iconXs:"h-6 w-6 rounded-lg",iconSm:"h-8 w-8 rounded-lg",iconMd:"h-10 w-10 rounded-xl",iconLg:"h-12 w-12 rounded-2xl",none:"",iconXl:"h-10 w-10 rounded-full",pill:"h-9 rounded-full px-3.5 py-2",nav:"h-8 rounded-xl px-3.5 text-sm font-medium",icon:"h-10 w-10 rounded-xl",default:"h-9 px-4 py-2 rounded-lg",noPadding:"h-9 rounded-lg"},rounded:{true:"rounded-full",false:null},btnColor:{default:null,danger:null},overideIconStyle:{true:"[&_svg]:text-inherit [&_svg]:hover:text-inherit",false:null}},compoundVariants:[{variant:"filled",btnColor:"danger",className:"text-white bg-red-500 hover:bg-red-400 disabled:hover:bg-red-500"},{variant:"filledSecondary",btnColor:"danger",className:"text-red-400 dark:text-red-300 hover:text-red-500 dark:text-red-200"},{variant:["outline","ghost","ghostSecondary","text"],btnColor:"danger",className:"text-red-400 dark:text-red-300 hover:text-red-500 dark:text-red-200 hover:bg-red-400/10"}],defaultVariants:{variant:"none",size:"md",rounded:!1,btnColor:"default"}}),c=r.forwardRef((e,t)=>{let{className:s,variant:i,size:r,btnColor:d="default",rounded:c=!1,asChild:u=!1,overideIconStyle:h=!1,...p}=e,m=u?n.DX:"button";return(0,o.jsx)(m,{className:(0,a.cn)(l({variant:i,size:r,rounded:c,btnColor:d,overideIconStyle:h,className:s})),ref:t,...!u&&{type:"button"},...p})});c.displayName="Button";let u=r.forwardRef((e,t)=>{let{className:s,variant:i,size:r,btnColor:c="default",rounded:u=!1,asChild:h=!1,overideIconStyle:p=!1,tooltipProps:m={},tooltipContent:v,tooltipContentProps:g={},tooltipAsChild:I,stayOpenOnClick:f=!1,...y}=e,S=h?n.DX:"button",b=y["aria-label"];return void 0===b&&"string"==typeof v&&(b=v),(0,o.jsxs)(d.m_,{delayDuration:100,...m,children:[(0,o.jsx)(d.k$,{asChild:!0,onClick:f?e=>e.preventDefault():void 0,children:(0,o.jsx)(S,{className:(0,a.cn)(l({variant:i,size:r,rounded:u,btnColor:c,overideIconStyle:p,className:s})),ref:t,...!h&&{type:"button"},"aria-label":b,...y})}),v?(0,o.jsx)(d.ZI,{onPointerDownOutside:f?e=>e.preventDefault():void 0,...g,children:v}):null]})});u.displayName="ButtonWithTooltip"},58192:(e,t,s)=>{s.d(t,{E8:()=>r,Sk:()=>o,Wl:()=>i,fG:()=>a,oQ:()=>n});let o="grok-3",n="Grok 3",i="Grok 3",r="grok-3",a="Grok 2"},61884:(e,t,s)=>{s.d(t,{Bc:()=>a,Gv:()=>u,ZI:()=>c,k$:()=>l,m_:()=>d});var o=s(79342),n=s(40251),i=s(88382),r=s(61312);let a=n.Kq,d=n.bL,l=n.l9,c=i.forwardRef((e,t)=>{let{className:s,sideOffset:i=4,disableAnimation:a,container:d,...l}=e;return(0,o.jsx)(n.ZL,{container:d,children:(0,o.jsx)(n.UC,{ref:t,collisionPadding:{top:16,right:16,bottom:16,left:16},sideOffset:i,className:(0,r.cn)("overflow-hidden rounded-md bg-popover shadow-sm dark:shadow-none px-3 py-1.5","text-xs text-popover-foreground pointer-events-none","max-w-80 text-wrap",a?"":(0,r.cn)("animate-in fade-in-0 zoom-in-95","data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95","data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2","data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2"),s),...l})})});c.displayName=n.UC.displayName;let u=(0,r.cn)("overflow-hidden rounded-2xl bg-primary text-primary-foreground","shadow-sm dark:shadow-none text-xs animate-in fade-in-0 zoom-in-95","data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95","data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 p-3");c.displayName=n.UC.displayName},65258:(e,t,s)=>{s.d(t,{BC:()=>y,CP:()=>b,L$:()=>p,MQ:()=>R,TF:()=>m,_q:()=>_,el:()=>v,gN:()=>I,kp:()=>h,lB:()=>S,oQ:()=>f,ok:()=>k,q5:()=>g,y$:()=>C});var o=s(17703),n=s(85431),i=s(3275),r=s(74995),a=s(53915),d=s(46815),l=s(82509),c=s(17823),u=s(76328);function h(e,t){return s=>{e(e=>({...e,[t]:s}),void 0,"assign:".concat(w(arguments)))}}function p(e,t){return()=>{e(e=>({...e,[t]:!e[t]}),void 0,"toggle:".concat(w(arguments)))}}function m(e,t){return s=>{e(e=>({...e,[t]:n.A([s],e[t])}),void 0,"remove:".concat(w(arguments)))}}function v(e,t,s){return o=>{e(e=>({...e,[t]:{...e[t],...i.A(r.A(s),[o])}}),void 0,"upsert:".concat(w(arguments)))}}function g(e,t){return(s,o)=>{e(e=>({...e,[t]:{...e[t],[o]:s}}),void 0,"idsert:".concat(w(arguments)))}}function I(e,t){return(s,o)=>{e(e=>({...e,[t]:{...e[t],[o]:[...e[t][o]||[],s]}}),void 0,"lisert:".concat(w(arguments)))}}function f(e,t,s){return(o,n)=>{let i=!1;return e(e=>{var r;return{...e,[t]:{...e[t],[o]:null==(r=e[t][o])?void 0:r.filter(e=>{let t=e[s]!==n;return t||(i=!0),t})}}},void 0,"delist:".concat(w(arguments))),i}}function y(e,t,s){return o=>{e(e=>({...e,[t]:{...e[t],...i.A(r.A(s),o)}}),void 0,"append:".concat(w(arguments)))}}function S(e,t,s,o){let{subscribe:n,setState:i}=e;return n(r.A(t),(e,t)=>{i(a.A(d.A(s),o(e,t)))},{fireImmediately:!0})}function b(e,t,s,n,i){let{subscribe:l,setState:c}=e;try{let e=globalThis.localStorage.getItem(s);if(null!=e){let s=JSON.parse(e);if(i){let e=i(s);c(a.A(d.A(t),e))}else c(a.A(d.A(t),s))}}catch(e){try{globalThis.localStorage.setItem(s,JSON.stringify(n))}catch(e){(0,o.vV)("zustand",e,{lsType:typeof globalThis.localStorage})}}l(r.A(t),e=>{globalThis.localStorage.setItem(s,JSON.stringify(e))})}function C(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return s?(0,l.v)()((0,c.lt)((0,c.eh)((t,s)=>new e(t,s)),{name:t,store:t})):(0,l.v)()((0,c.eh)((t,s)=>new e(t,s)))}function R(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return s?(0,l.v)()((0,c.lt)((0,c.eh)((0,u.D)((t,s)=>({...new e(t,s)}))),{name:t,store:t})):(0,l.v)()((0,c.eh)((0,u.D)((t,s)=>({...new e(t,s)}))))}function w(e){return String([...e].slice(1))}function k(e){return{data:e,status:"success",error:null}}function _(e){return{data:null,status:"error",error:e instanceof Error?e:Error("unknown error")}}},66570:(e,t,s)=>{let o;s.d(t,{V0:()=>m,IK:()=>I,sh:()=>g,au:()=>f,b2:()=>p,Lc:()=>v});var n=s(27248),i=s(17703),r=s(32507);let a=["origin","firstByte","pageReady","firstInput","submit","firstToken","firstSummaryToken","lastToken"];var d=s(5790),l=s(38541),c=s.n(l);let u="/"===globalThis.location.pathname,h={origin:0,firstByte:-1,pageReady:-1,firstInput:-1,submit:-1,firstToken:-1,firstSummaryToken:-1,lastToken:-1};function p(){-1===h.pageReady&&(h.pageReady=performance.now())}function m(){-1===h.firstInput&&(h.firstInput=performance.now())}function v(){-1===h.submit&&(h.submit=performance.now())}function g(){-1===h.firstToken&&(h.firstToken=performance.now())}function I(){-1===h.firstSummaryToken&&(h.firstSummaryToken=performance.now())}function f(e){-1===h.lastToken&&e&&!o&&(o=e,h.lastToken=performance.now()),function(){if(!u||(u=!1,!o))return;for(let e of Object.values(h))if(e<0)return;for(let e=1;e<a.length;e++){let t=h[a[e]],s=h[a[e-1]];if(t<0)return;if(t<s)return void(0,i.vV)("timeToValue:validate","Steps value should not be less that prev step value",{stepValue:t.toString(),prevStepValue:t.toString()})}(0,i.N8)("tryLogTimeToValue",{type:"time_to_value",modelMode:o,...h});let e=e=>e.toFixed(0),t=h[a[a.length-1]];(0,i.iu)("time_to_value",e(t),{location:"time-to-value",...c().mapValues(h,e)}),(0,i.iu)("time_to_value_step_first_input_submit",e(h.submit-h.firstInput),{location:"time-to-value"})}()}r.XO.subscribe((e,t)=>{("chat"!==e.route.page||"main"!==t.route.page)&&(u=!1)}),d.iV.subscribe((e,t)=>{(e.open||t.open)&&(u=!1)}),globalThis.addEventListener("hashchange",()=>{u=!1}),globalThis.document.addEventListener("visibilitychange",()=>{u=!1}),globalThis.addEventListener("blur",function(){u=!1}),globalThis.addEventListener("pagehide",()=>{u=!1}),(0,n.Ck)(e=>{-1===h.firstByte&&(h.firstByte=e.value)})},68332:(e,t,s)=>{s.d(t,{o:()=>m});var o=s(38614),n=s(41739),i=s(17703),r=s(84499),a=s(49972),d=s(39116),l=s(12110),c=s(88382);let u=[new l.w("/chat/:chatId"),new l.w("/chat"),new l.w("/"),new l.w("/c/:chatId"),new l.w("/c")],h=new l.w("/share/:shareLinkId"),p=new l.w("/s/:shareLinkId");function m(){let e=(0,d.useRouter)(),t=(0,d.usePathname)(),{push:s}=(0,r.wK)(),l=(0,c.useMemo)(()=>!!t&&u.some(e=>e.test(t)),[t]),m=(0,c.useMemo)(()=>!!t&&(h.test(t)||p.test(t)),[t]),v=(0,c.useMemo)(()=>{if(m){let e=h.test(t)||p.test(t);return{shareLinkId:null==e?void 0:e.shareLinkId}}},[m,t]),g=(0,c.useCallback)((t,r,d)=>{o.aP.getState().setConversationId(t);let{fetchGetConversation:c,byId:u}=a.w1.getState();if(t&&d){let e=n.a.getState();c(t).then(e.upsertConversationAsTab).catch((0,i.HX)("use-chat-router:routeToConversation:addToTabs"))}if(!r)if(t){var h,p;let o=null!=(p=null==(h=u[t])?void 0:h.temporary)&&p;s({page:"chat",conversationId:t,temporary:o}),l||e.push("/c/".concat(t))}else s({page:"main"})},[l,s,e]);return{isChatPage:l,isSharePage:m,pageData:v,routeToConversation:g,signInWithReturnTo:(0,c.useCallback)((s,o,n)=>{let i=new URLSearchParams({q:s||"",reasoningMode:o||"none",voice:n?"true":"false"}).toString(),r=i?"".concat(t,"?").concat(i):t,a=r?new URLSearchParams({return_to:r}).toString():void 0;e.push("/sign-in".concat(a?"?".concat(a):""))},[e,t])}}},69648:(e,t,s)=>{s.d(t,{w:()=>a});var o=s(79342),n=s(90808),i=s(88382),r=s(61312);let a=i.forwardRef((e,t)=>{let{className:s,orientation:i="horizontal",decorative:a=!0,...d}=e;return(0,o.jsx)(n.b,{ref:t,decorative:a,orientation:i,className:(0,r.cn)("shrink-0 bg-border","horizontal"===i?"h-[1px] w-full":"h-full w-[1px]",s),...d})});a.displayName=n.b.displayName},70888:(e,t,s)=>{s.d(t,{x:()=>c});var o=s(17703),n=s(65258),i=s(95158),r=s(14908),a=s(86530).hp;let d={listByConversationId:{},fileMetaPromiseById:{},fileMetaById:{},attachListByConversationId:{}};class l{constructor(e,t){this.set=e,this.get=t,this.listByConversationId=d.listByConversationId,this.fileMetaPromiseById=d.fileMetaPromiseById,this.fileMetaById=d.fileMetaById,this.attachListByConversationId=d.attachListByConversationId,this.lisertByConversationId=(0,n.gN)(this.set,"listByConversationId"),this.removeByConversationId=(0,n.TF)(this.set,"listByConversationId"),this.delistByConversationId=(0,n.oQ)(this.set,"listByConversationId","file"),this.upsertFileMetadata=(0,n.el)(this.set,"fileMetaById","fileMetadataId"),this.idsertFileMetadataPromise=(0,n.q5)(this.set,"fileMetaPromiseById"),this.lisertAttachByConversationId=(0,n.gN)(this.set,"attachListByConversationId"),this.removeAttachByConversationId=(0,n.TF)(this.set,"attachListByConversationId"),this.delistAttachByConversationId=(0,n.oQ)(this.set,"attachListByConversationId","assetId"),this.clear=()=>{this.set(d)},this.fetchUploadFile=(e,t,s)=>{let n=this.get(),r=e.arrayBuffer().then(t=>i.chatApi.chatUploadFile({body:{fileName:e.name,fileMimeType:e.type,content:a.from(t).toString("base64"),fileSource:s}}).then(e=>e).catch(e=>{if(e.message.includes("OUT_OF_RANGE"))throw Error("File was too large.");throw e})),d={file:e,metadataPromise:r};return n.lisertByConversationId(d,t),r.then(s=>{n.delistByConversationId(t,e)&&n.lisertByConversationId({...d,metadata:s},t)}).catch(s=>{n.delistByConversationId(t,e)&&(n.lisertByConversationId({...d,metadata:s},t),(0,o.vV)("fetchUploadFile",s))}),d},this.fetchFileMetadata=e=>{let t=this.get();if(e in t.fileMetaById&&t.fileMetaById[e])return Promise.resolve(t.fileMetaById[e]);if(e in t.fileMetaPromiseById&&t.fileMetaPromiseById[e])return t.fileMetaPromiseById[e];let s=i.chatApi.chatGetFileMetadata({fileMetadataId:e}).then(e=>e);return t.idsertFileMetadataPromise(s,e),s.then(t.upsertFileMetadata),s},this.fetchAttachThirdPartyFile=(e,t,s,n,a)=>{let d=this.get(),l=i.chatApi.chatUploadFile({body:{fileName:e,fileMimeType:t,fileSource:s,thirdPartyFileId:n}}).then(e=>e).catch(e=>{if(e.message.includes("OUT_OF_RANGE"))throw Error("File was too large.");throw e}),c=new File([n],e),u={file:c,metadataPromise:l};return d.lisertByConversationId(u,a),l.then(e=>{d.delistByConversationId(a,c)&&d.lisertByConversationId({...u,metadata:e},a)}).catch(e=>{d.delistByConversationId(a,c)&&(d.lisertByConversationId({...u,metadata:e},a),(0,o.vV)("fetchAttachThirdPartyFile",e)),e.message&&r.oR.error(e.message)}),u}}}let c=(0,n.y$)(l,"useFileStore")},83626:(e,t,s)=>{function o(e){let t=!1;return()=>{t||(e(),t=!0)}}function n(e,t){if(void 0!==e)return t(e)}s.d(t,{F:()=>n,S:()=>o})},84499:(e,t,s)=>{s.d(t,{KQ:()=>d,N_:()=>r,wK:()=>a});var o=s(79342),n=s(32507),i=s(88382);let r=(0,i.forwardRef)((e,t)=>{let{route:s,onClick:r,...a}=e,d=(0,n.XO)(e=>e.route),l=(0,n.J1)((0,n.Fp)(s,d)),c=(0,n.XO)(e=>e.push),u=(0,i.useCallback)(e=>{null==r||r(e),e.defaultPrevented||!function(e){let t=e.currentTarget.getAttribute("target");return t&&"_self"!==t||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||2===e.button}(e)&&(e.preventDefault(),c(s))},[r,c,s]);return(0,o.jsx)("a",{...a,onClick:u,href:l,ref:t})});function a(){let e=(0,n.XO)(e=>e.route),t=(0,n.XO)(e=>e.push),s=(0,n.XO)(e=>e.replace);return(0,i.useMemo)(()=>({push:t,replace:s,route:e}),[t,s,e])}function d(e,t){let s=(0,n.J1)((0,n.Fp)(e,e));return"".concat(t).concat(s)}},97960:(e,t,s)=>{s.d(t,{Jg:()=>A,Pn:()=>q,Ko:()=>L,Mn:()=>T,dr:()=>V,A3:()=>E});var o=s(38614),n=s(4295),i=s(98100),r=s(17703);let a=["Error in input stream","Connection closed"];var d=s(48992),l=s(14455),c=s(33960),u=s(66570),h=s(65258),p=s(95158),m=s(85467),v=s(95409),g=s(68541),I=s(1509),f=s(49972),y=s(44347),S=s(56907),b=s(99452),C=s.n(b),R=s(38541),w=s.n(R),k=s(81353),_=s(6132),M=s(56096);let T=_.z.object({memoryReferences:_.z.array(_.z.object({conversationId:_.z.string()})).optional().catch(void 0),deepsearchPreset:_.z.string().optional().catch(void 0),ui_layout:_.z.object({reasoningUiLayout:_.z.nativeEnum(m.ksv).optional().catch("UNSPECIFIED")}).optional().catch(void 0),artifactAction:_.z.enum(["ask","explain"]).optional().catch(void 0),agenticWorkspace:_.z.object({workspaceId:_.z.string()}).optional().catch(void 0),requestModelDetails:_.z.object({modelId:_.z.string().nullish(),name:_.z.string().nullish(),description:_.z.string().nullish()}).optional().catch(void 0),modelConfigOverride:y.DC.optional().catch(void 0),isMozart:_.z.boolean().optional().catch(void 0),parentQuotedText:_.z.string().optional().catch(void 0),usedCustomInstructions:_.z.boolean().optional().catch(void 0),is_think_harder:_.z.boolean().optional().catch(void 0),request_metadata:_.z.object({model:_.z.string().optional(),mode:_.z.string().optional(),effort:_.z.string().optional()}).optional().catch(void 0)}),P={nodesPromisesByConversationId:{},nodesByConversationId:{},initialResponsesPromisesByConversationId:{},loadMoreResponsesPromisesByConversationId:{},previewResponsesPromisesByConversationIdResponseId:{},conversationImageResponsesPromisesByConversationId:{},byId:{},byConversationId:{},imageIdByUrl:{},inflightPromisesByConversationId:{}};class x{constructor(e,t){var s=this;this.set=e,this.get=t,this.nodesPromisesByConversationId=P.nodesPromisesByConversationId,this.nodesByConversationId=P.nodesByConversationId,this.initialResponsesPromisesByConversationId=P.initialResponsesPromisesByConversationId,this.loadMoreResponsesPromisesByConversationId=P.loadMoreResponsesPromisesByConversationId,this.previewResponsesPromisesByConversationIdResponseId=P.previewResponsesPromisesByConversationIdResponseId,this.conversationImageResponsesPromisesByConversationId=P.conversationImageResponsesPromisesByConversationId,this.byId=P.byId,this.byConversationId=P.byConversationId,this.imageIdByUrl=P.imageIdByUrl,this.inflightPromisesByConversationId=P.inflightPromisesByConversationId,this.upsertResponse=(0,h.el)(this.set,"byId","responseId"),this.updateResponse=(e,t)=>{this.set(s=>{let o=s.byId[e];return o?{...s,byId:{...s.byId,[e]:{...o,...t}}}:s})},this.appendResponses=(0,h.BC)(this.set,"byId","responseId"),this.removeResponse=(0,h.TF)(this.set,"byId"),this.idsertInitialResponsesPromisesByConversationId=(0,h.q5)(this.set,"initialResponsesPromisesByConversationId"),this.removeInitialResponsesPromiseByConversationId=(0,h.TF)(this.set,"initialResponsesPromisesByConversationId"),this.idsertLoadMoreResponsesPromisesByConversationId=(0,h.q5)(this.set,"loadMoreResponsesPromisesByConversationId"),this.removeLoadMoreResponsesPromiseByConversationId=(0,h.TF)(this.set,"loadMoreResponsesPromisesByConversationId"),this.idsertPreviewResponsesPromisesByConversationIdResponseId=(0,h.q5)(this.set,"previewResponsesPromisesByConversationIdResponseId"),this.removePreviewResponsesPromiseByConversationIdResponseId=(0,h.TF)(this.set,"previewResponsesPromisesByConversationIdResponseId"),this.idsertConversationImageResponsesPromisesByConversationId=(0,h.q5)(this.set,"conversationImageResponsesPromisesByConversationId"),this.removeConversationImageResponsesPromiseByConversationId=(0,h.TF)(this.set,"conversationImageResponsesPromisesByConversationId"),this.setOneImageIdByUrl=(0,h.q5)(this.set,"imageIdByUrl"),this.idsertInflightPromisesByConversationId=(0,h.q5)(this.set,"inflightPromisesByConversationId"),this.idsertNodesByConversationId=(0,h.q5)(this.set,"nodesByConversationId"),this.idsertNodesPromisesByConversationId=(0,h.q5)(this.set,"nodesPromisesByConversationId"),this.removeNodesPromise=(0,h.TF)(this.set,"nodesPromisesByConversationId"),this.clear=()=>{this.set(P)},this.fetchListResponseNodes=async e=>{let t=this.get();if(t.nodesByConversationId[e])return t.nodesByConversationId[e];if(e in t.nodesPromisesByConversationId&&t.nodesPromisesByConversationId[e])return t.nodesPromisesByConversationId[e];let s=p.chatApi.chatListResponseNodes({conversationId:e,includeThreads:!0}).then(e=>{let{responseNodes:t=[]}=e;return t});return t.idsertNodesPromisesByConversationId(s,e),s.then(s=>{t.idsertNodesByConversationId(s,e)}).catch((0,r.HX)("response-store:fetchListResponseNodes")).finally(()=>{t.removeNodesPromise(e)}),s},this.fetchListInflightResponses=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=s.get();if(!t&&e in o.inflightPromisesByConversationId&&o.inflightPromisesByConversationId[e])return o.inflightPromisesByConversationId[e];let n=p.chatApi.chatListResponseNodes({conversationId:e,includeThreads:!0}).then(e=>{let{inflightResponses:t=[]}=e;return t});return o.idsertInflightPromisesByConversationId(n,e),n.then(o.appendResponses).catch((0,r.HX)("response-store:fetchListInflightResponses")),n},this.loadResponses=async(e,t)=>{let s=this.get(),o=t.filter(e=>!s.byId[e]);if(o.length){var n;let t=((null==(n=await p.chatApi.chatLoadResponses({conversationId:e,body:{responseIds:o}}))?void 0:n.responses)||[]).map(t=>{let s=T.optional().parse(t.metadata),{toolUsageResultById:o,traceSteps:n}=q(t.steps);return{...t,conversationId:e,metadata:s,memoryReferences:null==s?void 0:s.memoryReferences,deepsearchPreset:null==s?void 0:s.deepsearchPreset,parentQuotedText:null==s?void 0:s.parentQuotedText,usedCustomInstructions:null==s?void 0:s.usedCustomInstructions,requestMetadata:null==s?void 0:s.request_metadata,toolUsageResultById:o,traceSteps:n,threadParentId:t.threadParentId||"",state:"closed"}});s.appendResponses(t)}return t.map(e=>this.get().byId[e]).filter(e=>void 0!==e).sort((e,t)=>new Date(e.createTime).getTime()-new Date(t.createTime).getTime())},this.loadInitialResponses=async(e,t)=>{let s=this.get(),o=s.initialResponsesPromisesByConversationId[e];if(o)return o;let n=s.nodesPromisesByConversationId[e];return n||(n=this.fetchListResponseNodes(e)),o=(async()=>{try{let o=await n;if(!o.length)return[];if(t)return s.loadResponses(e,o.filter(e=>!!e.responseId&&!e.responseId.startsWith("optimistic_")&&!e.responseId.startsWith("streaming_in_progress_")).map(e=>e.responseId));let i=o.filter(e=>!e.threadParentId),r=i[i.length-1];if(!r)return[];let a=(0,d.d7)(r.responseId||"",i,30).filter(e=>!!e.responseId).map(e=>e.responseId);return s.loadResponses(e,a)}catch(e){return(0,r.vV)("response-store:loadInitialResponses",e),[]}})().finally(()=>{s.removeInitialResponsesPromiseByConversationId(e)}),s.idsertInitialResponsesPromisesByConversationId(o,e),o},this.loadMoreResponses=async(e,t)=>{var s;let o=this.get(),n=null==(s=o.nodesByConversationId[e])?void 0:s.filter(e=>!e.threadParentId);if(!n||!n.length)return[];if(e in o.initialResponsesPromisesByConversationId&&o.initialResponsesPromisesByConversationId[e])return o.initialResponsesPromisesByConversationId[e];let i=o.loadMoreResponsesPromisesByConversationId[e];return i||(i=(async()=>{try{let s=o.byConversationId[e]||[],i=(0,d.d7)(t,n),r=(0,d.m$)(i,s),a=i.findIndex(e=>e.responseId===(null==r?void 0:r.responseId)),l=i.slice(a+1,a+30+1).filter(e=>!!e.responseId).map(e=>e.responseId);return o.loadResponses(e,l)}catch(e){return(0,r.vV)("response-store:loadMoreResponses",e),[]}})().finally(()=>{o.removeLoadMoreResponsesPromiseByConversationId(e)}),o.idsertLoadMoreResponsesPromisesByConversationId(i,e)),i},this.loadPreviewResponses=async(e,t)=>{let s=this.get(),o=s.nodesPromisesByConversationId[e];o||(o=this.fetchListResponseNodes(e));let n=s.previewResponsesPromisesByConversationIdResponseId[e+t];return n||(n=(async()=>{try{let n=await o;if(!n.length)return{responses:[],hasOlderResponses:!1,hasNewerResponses:!1};let i=n[n.length-1];if(!i||!i.responseId)return{responses:[],hasOlderResponses:!1,hasNewerResponses:!1};let r=(0,d.d7)(i.responseId,n);if(!r.length)return{responses:[],hasOlderResponses:!1,hasNewerResponses:!1};let a=[];if(t&&r.some(e=>e.responseId===t)){let e=r.findIndex(e=>e.responseId===t),s=Math.max(0,e-5);a=r.slice(s,e+5+1).map(e=>e.responseId)}else a=r.slice(0,10).map(e=>e.responseId);let l=r[r.length-1],c=r[0],u=await s.loadResponses(e,a);return{responses:u,hasOlderResponses:!(null==u?void 0:u.some(e=>e.responseId===l.responseId)),hasNewerResponses:!(null==u?void 0:u.some(e=>e.responseId===c.responseId))}}catch(e){return(0,r.vV)("response-store:loadPreviewResponses",e),{responses:[],hasOlderResponses:!1,hasNewerResponses:!1}}})(),s.idsertPreviewResponsesPromisesByConversationIdResponseId(n,e+t)),n},this.loadConversationBranch=async(e,t,s)=>{let o=this.get(),n=o.nodesByConversationId[e];if(!n||!n.length)return[];let i=(0,d.d7)(t,n),r=i.slice(0,i.findIndex(e=>e.responseId===s)+1).filter(e=>!!e.responseId).map(e=>e.responseId);return o.loadResponses(e,r)},this.loadConversationImageResponses=async e=>{let t=this.get(),s=t.nodesPromisesByConversationId[e];s||(s=this.fetchListResponseNodes(e));let o=t.conversationImageResponsesPromisesByConversationId[e];return o||(o=(async()=>{try{let o=(await s).map(e=>e.responseId);return await t.loadResponses(e,o)}catch(e){return(0,r.vV)("response-store:loadConversationImageResponses",e),[]}})().finally(()=>{t.removeConversationImageResponsesPromiseByConversationId(e)}),t.idsertConversationImageResponsesPromisesByConversationId(o,e)),o},this.closeStaleResponsesInConversationAndUpsert=(e,t)=>{var s;let o=this.get(),n=t||{...o.byId,[e.responseId]:e};if("human"===e.sender&&["streaming","optimistic"].includes(null!=(s=e.state)?s:"")){let t=o.nodesByConversationId[e.conversationId];(t?t.filter(e=>!!e.responseId):[]).filter(t=>!!t.responseId&&t.responseId!==e.responseId&&t.parentResponseId!==e.parentResponseId).forEach(e=>{var t;let s=e.responseId,o=n[s];o&&["streaming","optimistic"].includes(null!=(t=o.state)?t:"")&&n[s]&&(n[s]={...o,state:"closed",partial:!0})})}this.set(e=>({...e,byId:n}))},this.streamResponse=e=>{var t,s,l,h;let m,v,g,{message:S,metadata:b={},parentResponseId:R,parentQuotedText:k,conversationId:_,modelName:T,fileAttachmentIds:P,webpageUrls:x,toolOverrides:E,customInstructions:V,customPersonality:L,deepsearchPreset:z,systemPromptName:q,isReasoning:j,imageEditUri:F,followUpType:Q,enableRetries:en,disableArtifactDiff:ei,onOptimisticUserResponse:er,onOptimisticModelResponse:ea,onStart:ed,onUserResponse:el,onStartExperiment:ec,onRealResponseId:eu,onCitations:eh,onDisclaimer:ep,onHasImage:em,onClose:ev,onWke:eg,onError:eI,onSideBySideConfig:ef,onSurvey:ey,isFromGrokFiles:eS,resumeResponseId:eb,disableToolComposer:eC=!1,disableMemory:eR=!1,modelMode:ew,ff:ek,threadParentId:e_,skipCancelCurrentInflightRequests:eM,disableArtifact:eT}=e,eP=this.get(),ex=f.w1.getState(),eB=(0,n.f)(),eE=M.x.getState().bestSubscription,eV=!S;if(eV){let e="",t="";if(eb&&eP.byId[eb]){let s=eP.byId[eb];e=s.message,t=s.thinkingTrace}let s=O({conversationId:_,responseId:"streaming_in_progress_".concat(C()()),parentResponseId:R||"",sender:T,state:"optimistic",message:e,thinkingTrace:t,threadParentId:e_},z,j,b),[o,n]=D();m={conversation:{conversationId:_},userResponse:{responseId:R||"",message:"",state:"mocked"},streamResponseById:{[s.responseId]:s},throttledUpsertResponse:o,forceUpsertResponse:n,conversationState:ex,responseState:eP,savedUserResponse:!0,closedStream:!1,modelMode:ew,startTimeMs:Date.now()},eP.upsertResponse(s),ea(s)}else{let e=N({conversationId:_,responseId:"optimistic_query_".concat(C()()),parentResponseId:R,message:S,parentQuotedText:k,fileAttachments:P,webpageUrls:x,state:"optimistic",threadParentId:e_});if(w().isEmpty(R)){let e=null==(t=eP.byConversationId[_])?void 0:t.length,s=eP.byConversationId[_];if(!s)throw Error("Never happens");let o=(0,d.Po)(s);(0,r.iu)("root_pivot",o.toString(),{location:"response-store",conversationId:_,totalResponses:String(e),longestBranchLength:String(o)})}let s=O({conversationId:_,responseId:"streaming_in_progress_".concat(C()()),parentResponseId:e.responseId,sender:T,state:"optimistic",threadParentId:e_},z,j,b),[o,n]=D();m={conversation:{conversationId:_},userResponse:e,streamResponseById:{[s.responseId]:s},throttledUpsertResponse:o,forceUpsertResponse:n,conversationState:ex,responseState:eP,savedUserResponse:!1,closedStream:!1,modelMode:ew,startTimeMs:Date.now()},eP.upsertResponse(m.userResponse),er(m.userResponse),eP.upsertResponse(s),ea(s)}let{modelConfigOverrideByModel:eA,isToolComposer2:eN,sideBySideMode:eO,userSettings:eU,skipResponseCache:eD}=y.C$.getState(),eL=null!=(s=eA[T||"undefined"])?s:{};if((0,y.Qy)(eL)){let e={...eL};e.useToolOverrides||delete e.tools,e.useSideBySideParams||delete e.sideBySideParams,e.sideBySideParams&&e.sideBySideParams.forEach(e=>{"grok-3"===e.model_name&&(e.model_name="grok-3-latest")}),b.modelConfigOverride=e}ek.ENABLE_IMAGINE_MODEL_OVERRIDE&&(b.modelConfigOverride={...b.modelConfigOverride,modelMap:{...null==(l=b.modelConfigOverride)?void 0:l.modelMap,imageGenModel:"imagine"}}),!eC&&(null!=eN?eN:ek.DEFAULT_USE_TOOL_COMPOSER2)&&(b.isMozart=!0),b.requestModelDetails=(0,i.I2)(T,ek);let ez=ek.SHOW_MODEL_MODE_SELECTOR&&eU.preferences.useModelModeSelector3?(0,o.vC)(ew):void 0;b.request_metadata={model:T,mode:ew||"none"};let eq=(h={parentResponseId:R,parentQuotedText:k,message:S,metadata:b,modelName:T,fileAttachments:P,webpageUrls:x,toolOverrides:E,enableSideBySide:"never"!==eO&&!eB,forceSideBySide:"always"===eO,systemPromptName:q,customInstructions:V,customPersonality:L,deepsearchPreset:z,disableArtifactDiff:ei,isReasoning:j,imageEditUri:F,followUpType:Q,isFromGrokFiles:eS,resumeResponseId:eb,disableMemory:eR,threadParentId:e_,modelMode:ez,skipCancelCurrentInflightRequests:eM,skipResponseCache:eD,isAsyncChat:eU.preferences.isAsyncChat,isRegenRequest:eV,supportedFastTools:ek.SHOW_FAST_TOOL?U:void 0,disableArtifact:eT},{message:"",modelName:"",parentResponseId:"",parentQuotedText:void 0,systemPromptName:void 0,disableSearch:!1,imageAttachments:[],returnImageBytes:!1,returnRawGrokInXaiRequest:!1,fileAttachments:[],enableImageGeneration:!0,forceConcise:!1,enableImageStreaming:!0,enableSideBySide:!0,sendFinalMetadata:!0,imageGenerationCount:A,deepsearchPreset:"",isReasoning:!1,disableTextFollowUps:!0,followUpType:"",disableMemory:!1,skipResponseCache:!1,supportedFastTools:void 0,...h}),ej={subscriptionTier:eE||"unknown",modelId:T,modelMode:ew||"none"},{log:eF,stop:eG,resetTime:eQ}=(0,r.Pp)("streamResponse",{type:"milliseconds_per_token",...ej}),eW=(0,r.wk)(e=>!!e&&(v=Date.now(),(0,r.iu)("response_start_streaming",e,{location:"response-store:streamResponse",conversationId:_,responseId:e,...ej}),!0)),eH=(0,r.wk)(e=>!!e&&(g=Date.now(),(0,r.iu)("response_start_streaming_summary",e,{location:"response-store:streamResponse",conversationId:_,responseId:e,...ej,deltaMs:(g-v).toString()}),!0)),eK=(0,r.wl)("streamResponse",{type:"time_to_first_token",...ej},e=>{eo(m,t=>{t.liveTimeToFirstTokenMs=e})}),e$=(0,r.hl)("streamResponse",{type:"time_to_first_chunk",...ej},e=>{eo(m,t=>{t.liveTimeToFirstChunkMs=e})}),eX=(0,r.NZ)("streamResponse",{type:"time_to_first_summary_token",...ej},e=>{eo(m,t=>{t.liveTimeToFirstSummaryTokenMs=e})});return p.chatApi.chatAddResponseRaw({conversationId:_,body:eq}).then(async e=>{for await(let t of(G(m,ed),(0,r.N8)("streamResponse",{type:"send_query_stream_start",...ej}),eQ(),(0,I.M)(e.raw))){if(e$(),eF(),t.error){let e=Error(t.error.message);throw eg(e),e}if(!t.result)continue;let e=t.result;W(m,e.userResponse),H(m,e.modelResponse),X(e,ef,_),$(m,e,ec),K(m,e,ey),J(m,e.userResponse,el)||(Y(m,e,{onCitations:eh,onHasImage:em,onDisclaimer:ep,onRealResponseId:eu}),(e.token||e.messageTag)&&(eK(),eW(e.responseId),e.isThinking||(eX(),eH(e.responseId))),Z(m,e,ev))}ee(m,S,el),et(m),(0,u.au)(ew),(0,r.N8)("streamResponse",{type:"send_query_stream_success",...ej})}).catch(e=>{if((0,c.GQ)(e)){var t;(t=e instanceof Error?e.message:String(e),a.some(e=>t.includes(e)))?!function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=e instanceof Error?e.message:String(e);(0,r.iu)("sse_disconnection_error",o,{location:t,errorType:e instanceof Error?e.name:"UnknownError",userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown",...s})}(e,"response-store:useResponseStore:streamResponse",{conversationId:_,modelName:T,isReasoning:j?j.toString():"",deepsearchPreset:z||""}):(0,r.vV)("response-store:useResponseStore:streamResponse",e,{conversationId:_,modelName:T,isReasoning:j?j.toString():"",deepsearchPreset:z||""}),(0,r.N8)("streamResponse",{type:"send_query_stream_error",...ej})}let s=eI(e);en&&s?B(T,_,m.streamResponseById,j,z,ew,ed,eh,ep,em,ev,eg,ek).catch(e=>{throw(0,r.vV)("response-store:useResponseStore:streamResponse:handleStreamError",e),e}):es(m,e,ev)}).finally(()=>{eG()})},this.reconnectToResponse=e=>{let{inflightResponse:t,conversationId:s,modelName:o,parentResponseId:n,enableRetries:i,isReasoning:a,deepsearchPreset:d,modelMode:l,onStart:u,onCitations:h,onDisclaimer:m,onHasImage:v,onClose:g,onWke:y,onError:S,noHandleError:b=!1,ff:C,threadParentId:R}=e,w=t.responseId;if(!w)throw Error("Inflight response missing responseId");let k=this.get(),_=f.w1.getState(),T=M.x.getState().bestSubscription,[P,x]=D(),E={conversation:{conversationId:s},userResponse:{responseId:t.parentResponseId||"",message:"",state:"mocked"},streamResponseById:{},throttledUpsertResponse:P,forceUpsertResponse:x,conversationState:_,responseState:k,savedUserResponse:!0,closedStream:!1,modelMode:l,startTimeMs:t.createTime?new Date(t.createTime).getTime():Date.now()},V={subscriptionTier:T||"unknown",modelId:o,modelMode:l||"none"},{log:A,stop:N,resetTime:U}=(0,r.Pp)("reconnectToResponse",{type:"milliseconds_per_token",...V});return p.chatApi.chatReconnectResponseV2Raw({responseId:w}).then(async e=>{var i,a,d,l;(0,r.N8)("reconnectToResponse",{type:"send_query_stream_reconnect_start",...V}),U();let c=(0,I.M)(e.raw);A();let p=await c.next();if(!(null==(i=p.value)?void 0:i.result)||!(null==(l=p.value)||null==(d=l.result)||null==(a=d.response)?void 0:a.modelResponse))throw Error("No initial state received from reconnect");let{title:f,response:S}=p.value.result;for await(let e of(Q(E,f),E.streamResponseById[w]=O({...S.modelResponse,responseId:t.responseId,inflightResponseId:t.responseId,conversationId:s,parentResponseId:n,sender:o,state:"streaming",...t.createTime&&{createTime:t.createTime},threadParentId:R}),Y(E,S,{onCitations:h,onHasImage:v,onDisclaimer:m,onRealResponseId:()=>{}}),G(E,u),c)){if(A(),e.error){let t=Error(e.error.message);throw y(t),t}if(!e.result)continue;let{title:t,response:s}=e.result;Q(E,t),s&&(W(E,s.userResponse),H(E,s.modelResponse),J(E,s.userResponse,()=>{})||(Y(E,s,{onCitations:h,onHasImage:v,onDisclaimer:m,onRealResponseId:()=>{}}),Z(E,s,g)))}et(E),(0,r.N8)("reconnectToResponse",{type:"send_query_stream_reconnect_success",...V})}).catch(e=>{if(b)throw e;(0,c.GQ)(e)&&((0,r.vV)("response-store:reconnectToResponse",e,{conversationId:E.conversation.conversationId,modelName:o,isReasoning:a?a.toString():"",deepsearchPreset:d||""}),(0,r.N8)("reconnectToResponse",{type:"send_query_stream_reconnect_error",...V}));let t=S(e);i&&t?B(o,E.conversation.conversationId,E.streamResponseById,a,d,l,u,h,m,v,g,y,C).catch(e=>{throw(0,r.vV)("response-store:reconnectToResponse:handleStreamError",e),e}):es(E,e,g)}).finally(()=>{N()})},this.streamCreateAndRespond=async e=>{var t,s,a;let d,l,{temporary:h,message:m,modelName:v,fileAttachmentIds:g,webpageUrls:S,systemPromptName:b,personaId:C,toolOverrides:R,isPreset:w,customInstructions:k,customPersonality:_,deepsearchPreset:T,isReasoning:P,imageEditUri:x,enableRetries:E,disableArtifactDiff:V,onOptimisticConversation:N,onOptimisticResponse:O,onStart:D,onConversation:L,onUserResponse:z,onStartExperiment:q,onRealResponseId:j,onCitations:en,onDisclaimer:ei,onHasImage:er,onClose:ea,onWke:ed,onError:el,onSideBySideConfig:ec,onSurvey:eu,workspaceIds:eh,responseMetadata:ep={},isFromGrokFiles:em,disableToolComposer:ev=!1,disableMemory:eg=!1,modelMode:eI,ff:ef}=e,ey=this.get(),eS=f.w1.getState(),eb=(0,n.f)(),eC=M.x.getState().bestSubscription,eR=F({message:m,modelMode:eI,fileAttachmentIds:g,webpageUrls:S,personaId:C,temporary:h,modelName:v,deepsearchPreset:T,isReasoning:P,fromPreset:w,metadata:ep}),ew=Object.values(eR.streamResponseById)[0];eS.upsertAndCacheConversation(eR.conversation),N(eR.conversation),ey.upsertResponse(eR.userResponse),O(eR.userResponse),ew&&ey.upsertResponse(ew);let{modelConfigOverrideByModel:ek,isToolComposer2:e_,sideBySideMode:eM,userSettings:eT,skipResponseCache:eP}=y.C$.getState(),ex=null!=(t=ek[v||"undefined"])?t:{};if((0,y.Qy)(ex)){let e={...ex};e.useToolOverrides||delete e.tools,e.useSideBySideParams||delete e.sideBySideParams,e.sideBySideParams&&e.sideBySideParams.forEach(e=>{"grok-3"===e.model_name&&(e.model_name="grok-3-latest")}),ep.modelConfigOverride=e}ef.ENABLE_IMAGINE_MODEL_OVERRIDE&&(ep.modelConfigOverride={...ep.modelConfigOverride,modelMap:{...null==(s=ep.modelConfigOverride)?void 0:s.modelMap,imageGenModel:"imagine"}}),!ev&&(null!=e_?e_:ef.DEFAULT_USE_TOOL_COMPOSER2)&&(ep.isMozart=!0),ep.requestModelDetails=(0,i.I2)(v,ef);let eB=(a={temporary:h,message:m,modelName:v,fileAttachments:g,webpageUrls:S,systemPromptName:null!=b?b:C,toolOverrides:R,enableSideBySide:"never"!==eM&&!eb,forceSideBySide:"always"===eM,customInstructions:k,customPersonality:_,deepsearchPreset:T,isReasoning:P,disableArtifactDiff:V,imageEditUri:x,workspaceIds:eh,isFromGrokFiles:em,responseMetadata:ep,disableMemory:eg,modelMode:ef.SHOW_MODEL_MODE_SELECTOR&&eT.preferences.useModelModeSelector3?(0,o.vC)(eI):void 0,skipResponseCache:eP,isAsyncChat:eT.preferences.isAsyncChat,supportedFastTools:ef.SHOW_FAST_TOOL?U:void 0},{systemPromptName:"",temporary:!1,message:"",modelName:"",fileAttachments:[],imageAttachments:[],disableSearch:!1,enableImageGeneration:!0,returnImageBytes:!1,returnRawGrokInXaiRequest:!1,enableImageStreaming:!0,imageGenerationCount:A,forceConcise:!1,enableSideBySide:!0,sendFinalMetadata:!0,disableTextFollowUps:!0,skipResponseCache:!1,supportedFastTools:void 0,...a}),eE={subscriptionTier:eC||"unknown",modelId:v,modelMode:eI||"none"},{log:eV,stop:eA,resetTime:eN}=(0,r.Pp)("streamCreateAndRespond",{type:"milliseconds_per_token",...eE}),eO=(0,r.wk)(e=>!!e&&(d=Date.now(),(0,r.iu)("response_start_streaming",e,{location:"response-store:streamResponse",conversationId:eR.conversation.conversationId,responseId:e,...eE}),!0)),eU=(0,r.wk)(e=>!!e&&(l=Date.now(),(0,r.iu)("response_start_streaming_summary",e,{location:"response-store:streamCreateAndRespond",conversationId:eR.conversation.conversationId,responseId:e,...eE,deltaMs:(l-d).toString()}),!0)),eD=(0,r.wl)("streamCreateAndRespond",{type:"time_to_first_token",...eE},e=>{eo(eR,t=>{t.liveTimeToFirstTokenMs=e})}),eL=(0,r.hl)("streamCreateAndRespond",{type:"time_to_first_chunk",...eE},e=>{(0,u.sh)(),eo(eR,t=>{t.liveTimeToFirstChunkMs=e})}),ez=(0,r.NZ)("streamCreateAndRespond",{type:"time_to_first_summary_token",...eE},e=>{(0,u.IK)(),eo(eR,t=>{t.liveTimeToFirstSummaryTokenMs=e})});return p.chatApi.chatCreateConversationAndRespondRaw({body:eB}).then(async e=>{for await(let t of(G(eR,D),(0,r.N8)("streamCreateAndRespond",{type:"send_query_stream_start",...eE}),eN(),(0,I.M)(e.raw))){if(eL(),eV(),t.error){let e=Error(t.error.message);throw ed(e),e}if(!t.result)continue;let{response:e,conversation:s,title:o}=t.result;if(function(e,t,s){if(!t)return;let o=e.conversation.conversationId;e.conversation.state="closed",e.conversation={...e.conversation,...t},e.userResponse.conversationId=e.conversation.conversationId,eo(e,t=>{t.parentResponseId=e.userResponse.responseId,t.conversationId=e.conversation.conversationId}),e.throttledUpsertResponse(e.userResponse),eo(e,e.forceUpsertResponse),s(e.conversation),e.conversationState.upsertAndCacheConversation(e.conversation,o)}(eR,s,L),Q(eR,o),e){if(W(eR,e.userResponse),H(eR,e.modelResponse),X(e,ec,eR.conversation.conversationId),$(eR,e,q),K(eR,e,eu),J(eR,e.userResponse,z))continue;Y(eR,e,{onCitations:en,onHasImage:er,onDisclaimer:ei,onRealResponseId:j}),(e.token||e.messageTag)&&(eD(),eO(e.responseId),e.isThinking||(ez(),eU(e.responseId))),Z(eR,e,ea)}}ee(eR,m,z),et(eR),(0,u.au)(eI),(0,r.N8)("streamCreateAndRespond",{type:"send_query_stream_success",...eE})}).catch(e=>{(0,c.GQ)(e)&&((0,r.vV)("response-store:streamCreateAndRespond",e,{conversationId:eR.conversation.conversationId,modelName:v,isReasoning:P?P.toString():"",deepsearchPreset:T||""}),(0,r.N8)("streamCreateAndRespond",{type:"send_query_stream_error",...eE}));let t=el(e);E&&t?B(v,eR.conversation.conversationId,eR.streamResponseById,P,T,eI,D,en,ei,er,ea,ed,ef).catch(e=>{throw(0,r.vV)("response-store:streamCreateAndRespond:handleStreamError",e),e}):es(eR,e,ea)}).finally(()=>{eA()})},this.abortStream=async(e,t,s)=>{let o=this.get(),n=f.w1.getState(),i=o.byId[t];if(!i||!i.state||!["streaming","error","reconnecting"].includes(i.state))return Promise.resolve(t);let r=n.abortControllerById[e];return r&&(r.abort(),n.removeAbortControllerById(e)),(s?p.chatApi.chatStopInflightResponse({responseId:t}):p.chatApi.chatStopConversationInflightResponses({conversationId:e})).then(()=>{var t;let n={...i,responseId:null!=(t=i.inflightResponseId)?t:i.responseId,conversationId:e,state:"closed",partial:!0,liveThinkingEndTime:i.liveThinkingStartTime&&!i.liveThinkingEndTime?Date.now():i.liveThinkingEndTime,searchingEndTime:i.searchingStartTime&&!i.searchingEndTime?Date.now():i.searchingEndTime};return s?o.upsertResponse(n):o.closeStaleResponsesInConversationAndUpsert(n),n.responseId}).catch(e=>{let t={...i,state:"error",liveThinkingEndTime:i.liveThinkingStartTime&&!i.liveThinkingEndTime?Date.now():i.liveThinkingEndTime,searchingEndTime:i.searchingStartTime&&!i.searchingEndTime?Date.now():i.searchingEndTime};throw o.upsertResponse(t),e})},this.addUserResponse=(e,t,s)=>p.chatApi.chatAddUserResponse({conversationId:e,body:{message:t,parentResponseId:s}}).then(t=>{let s=this.get(),o={...t,conversationId:e};return s.upsertResponse(o),o}),this.addToolResponse=(e,t)=>p.chatApi.chatAddToolResponse({body:{responseId:e,toolResponse:t}}).then(()=>{let s=this.get(),o=s.byId[e];if(o){let e={...o,toolResponses:[...o.toolResponses||[],t]};return s.upsertResponse(e),e}throw Error("Response not found in state")}),this.createVoiceUserMessage=e=>{let{userResponseId:t,conversationId:s,parentResponseId:o,message:n,onUserResponse:i,onOptimisticModelResponse:r}=e,a=this.get(),d=N({responseId:t,parentResponseId:o,message:n,conversationId:s,state:"closed",partial:!1});a.upsertResponse(d),i(d);let l=O({conversationId:s,responseId:"streaming_in_progress_".concat(C()()),parentResponseId:d.responseId,sender:"ASSISTANT",state:"streaming"});a.upsertResponse(l),r(l)},this.loadThreadMessages=async(e,t)=>{let s=this.get();try{let o=(await this.fetchListResponseNodes(e)).filter(e=>e.threadParentId===t);if(!o.length)return[];let n=o.filter(e=>!!e.responseId).map(e=>e.responseId);return(await s.loadResponses(e,n)).sort((e,t)=>new Date(e.createTime).getTime()-new Date(t.createTime).getTime())}catch(e){return(0,r.vV)("response-store:loadThreadMessages",e),[]}}}}async function B(e,t,s,o,n,i,a,d,u,h,m,v,g){let I=E.getState(),y=f.w1.getState(),S=M.x.getState().bestSubscription,b={conversation:{conversationId:t},userResponse:{responseId:"",message:""},streamResponseById:w().mapValues(s,e=>("closed"===e.state||(e.state="error"),e)),throttledUpsertResponse:()=>{},forceUpsertResponse:()=>{},conversationState:y,responseState:I,savedUserResponse:!0,closedStream:!1,modelMode:i,startTimeMs:Date.now()};if(t.startsWith("optimistic_conversation_"))return void eo(b,e=>{e.state="error",b.forceUpsertResponse(e)});eo(b,I.upsertResponse);let C={subscriptionTier:S||"unknown",modelId:e,modelMode:i||"none"};(0,r.N8)("handleStreamError",{type:"send_query_stream_auto_reconnect_start",...C});for(let s=1;s<=10;s++)try{for(let s of(await I.fetchListInflightResponses(t,!0)))(null==s?void 0:s.responseId)&&await I.reconnectToResponse({inflightResponse:s,conversationId:t,modelName:e,parentResponseId:s.parentResponseId||"",enableRetries:!0,isReasoning:o,deepsearchPreset:n,modelMode:i,onStart:a,onCitations:d,onDisclaimer:u,onHasImage:h,onClose:m,onWke:v,onError:()=>!0,noHandleError:!0,ff:g})}catch(e){if((0,r.vV)("response-store:handleStreamError:retryError",e),(0,c.GQ)(e)&&((0,r.N8)("handleStreamError",{type:"send_query_stream_auto_reconnect_error",...C}),(0,r.N8)("handleStreamError",{type:"send_query_stream_reconnect_error",...C})),10===s)throw(0,r.N8)("handleStreamError",{type:"send_query_stream_auto_reconnect_fail",...C}),eo(b,e=>{e.state="error",b.forceUpsertResponse(e)}),e;await (0,l.N)(2e3)(),eo(b,e=>{e.state="reconnecting",b.forceUpsertResponse(e)})}let R=Object.values(b.streamResponseById).filter(e=>!e.responseId.startsWith("optimistic_")&&!e.responseId.startsWith("streaming_in_progress_")),k=((await p.chatApi.chatLoadResponses({conversationId:t,body:{responseIds:R.map(e=>e.responseId)}})).responses||[]).map(e=>{let s=T.optional().parse(e.metadata),{toolUsageResultById:o,traceSteps:n}=q(e.steps);return{...e,conversationId:t,metadata:s,memoryReferences:null==s?void 0:s.memoryReferences,deepsearchPreset:null==s?void 0:s.deepsearchPreset,parentQuotedText:null==s?void 0:s.parentQuotedText,usedCustomInstructions:null==s?void 0:s.usedCustomInstructions,requestMetadata:null==s?void 0:s.request_metadata,toolUsageResultById:o,traceSteps:n,threadParentId:e.threadParentId||"",state:"closed"}});k.length&&(I.appendResponses(k),m(k))}let E=(0,h.y$)(x,"useResponseStore",!0);function V(e,t){return E(s=>{var o;return e?null==(o=s.byId[e])?void 0:o[t]:void 0})}(0,h.lB)(E,"byId","byConversationId",(e,t)=>{let s=Object.values(e),o=E.getState().byConversationId,n=new Set(w().filter(s,e=>e!==t[e.responseId]||!!e.state&&"closed"!==e.state).map(e=>e.conversationId)),i=s.filter(e=>n.has(e.conversationId)),r=k.A(e=>e.conversationId,i);return{...o,...w().pick(r,[...n.values()])}}),(0,h.lB)(E,"byId","nodesByConversationId",e=>{let t=E.getState().nodesByConversationId,s=!1,o={};for(let n in e){let i=e[n];if(!i)continue;let r=i.conversationId,a=t[r]||[],d=a.find(e=>e.responseId===n);d?"streaming"===i.state&&d.parentResponseId!==i.parentResponseId&&(s=!0,o[r]=[...a,{...d,parentResponseId:i.parentResponseId,threadParentId:i.threadParentId}]):(s||(s=!0,o={...t}),o[r]?o[r]===a&&(o[r]=[...a]):o[r]=[...a],o[r].push({responseId:n,parentResponseId:i.parentResponseId,sender:i.sender,threadParentId:i.threadParentId}))}return s?o:t});let A=2;function N(e){var t;return{sender:"human",createTime:new Date().toISOString(),manual:!1,partial:!0,shared:!1,isControl:!1,query:"",queryType:"",thinkingTrace:"",webSearchResults:[],xpostIds:[],xposts:[],generatedImageUrls:[],imageAttachments:[],imageEditUris:[],fileAttachments:[],cardAttachmentsJson:[],fileUris:[],fileAttachmentsMetadata:[],state:"optimistic",parentResponseId:"",parentQuotedText:void 0,steps:[],imageEditUri:"",error:"",mediaTypes:[],webpageUrls:[],citedWebSearchResults:[],metadata:{},uiLayout:{reasoningUiLayout:"UNSPECIFIED"},selectedFileTextContent:"",selectedFileTextContentStartPosition:0,selectedFileTextContentEndPosition:0,toolResponses:[],toolUsageResultById:{},traceSteps:[],threadParentId:null!=(t=e.threadParentId)?t:"",model:"",sideBySideConfig:{},requestMetadata:{},...e}}function O(e,t,s,o){var n;let i="default"===t?Date.now():void 0,r=s?Date.now():void 0;return{message:"",createTime:new Date().toISOString(),manual:!1,partial:!0,shared:!1,isControl:!1,query:"",queryType:"",thinkingTrace:"",webSearchResults:[],xpostIds:[],xposts:[],generatedImageUrls:[],imageAttachments:[],imageEditUris:[],fileAttachments:[],cardAttachmentsJson:[],fileUris:[],fileAttachmentsMetadata:[],state:"streaming",steps:[],imageEditUri:"",error:"",mediaTypes:[],webpageUrls:[],citedWebSearchResults:[],metadata:o||{},deepsearchPreset:t,generatedImageHeight:void 0,generatedImageWidth:void 0,model:"",...e,liveThinkingStartTime:r,searchingStartTime:i,selectedFileTextContent:"",selectedFileTextContentStartPosition:0,selectedFileTextContentEndPosition:0,uiLayout:{reasoningUiLayout:"UNSPECIFIED"},toolResponses:[],toolUsageResultById:{},traceSteps:[],threadParentId:null!=(n=e.threadParentId)?n:"",sideBySideConfig:{},fastToolResponse:void 0,requestMetadata:(null==o?void 0:o.request_metadata)?{model:o.request_metadata.model,mode:function(e){if(e&&Object.values(v.it).includes(e))return e}(o.request_metadata.mode),effort:function(e){if(e&&Object.values(g.wF).includes(e))return e}(o.request_metadata.effort)}:{}}}let U={calculatorTool:"1",unitConversionTool:"1"};function D(){let e,t={};return[s=>{if(!e){E.getState().upsertResponse(s),e=setTimeout(()=>{let s=Object.values(t);t={},s.length&&E.getState().appendResponses(s),e=void 0},30);return}t[s.responseId]=s},s=>{s&&(t[s.responseId]=s),clearTimeout(e);let o=Object.values(t);t={},o.length&&E.getState().appendResponses(o),e=void 0}]}function L(e){var t;return e.liveThinkingStartTime||e.searchingStartTime||e.thinkingStartTime||(null==(t=e.progressReport)?void 0:t.category)==="HEAVY_ROLLOUT"}let z=RegExp("(".concat(/- .*/.source,")|(").concat(/<xai:tool_usage_card>[\s\S]*?<\/xai:tool_usage_card>/.source,")"),"g");function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t={},s=[];for(let o of e){if(o.toolUsageResults)for(let e of o.toolUsageResults)e.toolUsageCardId&&(t[e.toolUsageCardId]=w().merge(t[e.toolUsageCardId],e));if(o.text&&o.tags){let{rolloutId:e}=o;w().sortBy(w().zip(o.tags,o.text),e=>{var t;return null!=(t=j[e[0]||""])?t:3}).forEach(t=>{let[o,n]=t;if(n)switch(o){case"summary":{let t=n.match(z);null==t||t.forEach(t=>{t.startsWith("-")?s.push({type:"summary",text:t,rolloutId:e}):s.push({type:"tool",text:t,rolloutId:e})});break}case"header":s.push({type:"header",text:n,rolloutId:e})}})}}return{toolUsageResultById:t,traceSteps:s}}let j={header:0,summary:1,tool:1},F=e=>{let{message:t,modelMode:s,fileAttachmentIds:o,webpageUrls:n,personaId:i,temporary:r,modelName:a,deepsearchPreset:d,isReasoning:l,fromPreset:c,metadata:u}=e,h="optimistic_conversation_".concat(C()()),p=(0,f.b2)({conversationId:h,personaId:i,temporary:r,fromPreset:c}),m="optimistic_response_".concat(C()()),v=N({conversationId:p.conversationId,responseId:m,message:t,fileAttachments:o,webpageUrls:n}),g="streaming_in_progress_".concat(C()()),I=O({conversationId:p.conversationId,responseId:g,parentResponseId:v.responseId,sender:a},d,l,u),y={[I.responseId]:I},[S,b]=D();return{conversation:p,userResponse:v,streamResponseById:y,throttledUpsertResponse:S,forceUpsertResponse:b,conversationState:f.w1.getState(),responseState:E.getState(),savedUserResponse:!1,closedStream:!1,modelMode:s,startTimeMs:Date.now()}};function G(e,t){"mocked"!==e.userResponse.state&&(e.userResponse={...e.userResponse,state:"streaming"},e.forceUpsertResponse(e.userResponse)),eo(e,t=>{t.state="streaming",e.forceUpsertResponse(t)}),t(Object.values(e.streamResponseById).flat())}function Q(e,t){(null==t?void 0:t.newTitle)&&e.conversationState.upsertAndCacheConversation({...e.conversation,title:t.newTitle})}function W(e,t){if(null==t?void 0:t.error)throw e.userResponse={...e.userResponse,...t,state:"error"},e.forceUpsertResponse(e.userResponse),(0,r.vV)("maybeProcessUserChunkError",t.error),Error(t.error)}function H(e,t){if(null==t?void 0:t.error)throw eo(e,s=>{Object.assign(s,t,{state:"error"}),e.forceUpsertResponse(s)}),(0,r.vV)("maybeProcessModelChunkError",t.error),Error(t.error)}function K(e,t,s){t.survey&&s(t.survey)}function $(e,t,s){var o,n;if(null==t.sideBySideIndex||t.responseId&&e.streamResponseById[t.responseId])return;let i=Object.values(e.streamResponseById)[0];if(!i)return;let r=null!=(o=t.responseId)?o:"streaming_in_progress_".concat(t.sideBySideIndex,"_").concat(C()()),a=O({conversationId:e.conversation.conversationId,responseId:t.responseId||r,parentResponseId:e.userResponse.responseId,sender:i.sender,threadParentId:void 0,uiLayout:i.uiLayout});null!=i.experimentIds||(i.experimentIds=[]),i.experimentIds.push(a.responseId),e.streamResponseById[r]=a,e.forceUpsertResponse(i),e.forceUpsertResponse(a),s([i.responseId,...i.experimentIds])}function X(e,t,s){e.sideBySideConfig&&t(e.sideBySideConfig,s)}function J(e,t,s){var o,n;return!!t&&(e.userResponse={...e.userResponse,...t,conversationId:e.conversation.conversationId,state:"closed",threadParentId:null!=(n=null==(o=e.userResponse)?void 0:o.threadParentId)?n:""},e.forceUpsertResponse(e.userResponse),s(e.userResponse),e.savedUserResponse=!0,eo(e,t=>{var s;t.parentResponseId=null==(s=e.userResponse)?void 0:s.responseId,e.forceUpsertResponse(t)}),!0)}function Y(e,t,s){var o,n,i,a,d,l,c,u,h;let{onCitations:p,onHasImage:m,onDisclaimer:v,onRealResponseId:g}=s,{responseId:I,token:f,modelResponse:y,webSearchResults:S,citedWebSearchResults:b,xSearchResults:C,queryAction:R,cachedImageGenerationResponse:k,followUpSuggestions:_,cardAttachment:M,streamingImageGenerationResponse:T,finalMetadata:P,isThinking:x,messageTag:B,messageStepId:E,bannerMessage:V,disclaimer:A,imageAttachmentInfo:N,progressReport:U,memoryReferences:D,imageDimensions:L,followUpSuggestedMode:z,uiLayout:j,authNotification:F,toolUsageCardId:G,rolloutId:Q,sideBySideIndex:W,fastToolResponse:H}=t,K=I?e.streamResponseById[I]:Object.values(e.streamResponseById)[null!=W?W:0];if(!K){if(!I)return;let t=Object.values(e.streamResponseById).find(e=>e.responseId.startsWith("streaming_in_progress_"));if(t)K={...t},delete e.streamResponseById[t.responseId],e.responseState.removeResponse(t.responseId),K.responseId=I,K.inflightResponseId=I,g(I);else{let t=null!=(i=null==y?void 0:y.parentResponseId)?i:null==(n=Object.values(e.streamResponseById)[0])?void 0:n.responseId;K=O({conversationId:e.conversation.conversationId,responseId:I,parentResponseId:t,sender:null!=(a=null==y?void 0:y.model)?a:"assistant",uiLayout:j,threadParentId:null==y?void 0:y.threadParentId})}e.streamResponseById[I]=K,e.forceUpsertResponse(K)}if(void 0!=E&&K.steps.length<=E&&(K.steps=[...K.steps,...w().map(Array(E-K.steps.length+1),()=>({text:[],tags:[],webSearchResults:[],xpostIds:[],xposts:[],toolUsageResults:[],rolloutId:null!=Q?Q:""}))]),y){let t={...K,...y,state:K.authNotification?"streaming":"closed"};e.streamResponseById[t.responseId]=t,K=t}if(R&&(("aurora"===R.type||"flux"===R.type||"imagine"===R.type)&&(K.imageModel=R.type,K.hasImages=!0,m()),"x"===R.type&&(K.hasSearches=!0)),N&&N.imageAttachmentCount&&(K.imageAttachmentCount=N.imageAttachmentCount),L&&(L.height&&(K.generatedImageHeight=L.height),L.width&&(K.generatedImageWidth=L.width)),null==S?void 0:S.results)if(void 0!=E){let e=K.steps[E];if(e&&(e.webSearchResults=S.results||[],G)){let t={toolUsageCardId:G,webSearchResults:{results:S.results}};e.toolUsageResults=[...e.toolUsageResults||[],t]}}else 0===K.steps.length&&(K.webSearchResults=[...K.webSearchResults||[],...S.results||[]],p(K));if(null==C?void 0:C.results)if(void 0!=E){let e=K.steps[E];if(e){if(e.xposts=C.results||[],e.xpostIds=w().compact(e.xposts.map(e=>e.postId)),G){let t={toolUsageCardId:G,xSearchResults:{results:C.results}};e.toolUsageResults=[...e.toolUsageResults||[],t]}}else K.steps.push({text:[],tags:[],webSearchResults:[],xpostIds:w().compact(C.results.map(e=>e.postId)),xposts:C.results||[],toolUsageResults:G?[{toolUsageCardId:G,xSearchResults:{results:C.results}}]:[],rolloutId:null!=Q?Q:""})}else 0===K.steps.length&&(K.xposts=[...K.xposts||[],...C.results||[]],K.xpostIds=w().compact(K.xposts.map(e=>e.postId)),p(K));(null==b?void 0:b.results)&&(K.citedWebSearchResults=[...K.citedWebSearchResults||[],...b.results||[]],p(K)),k&&k.imageUrl&&(K.generatedImageUrls=K.generatedImageUrls.concat([k.imageUrl])),M&&M.jsonData&&(K.cardAttachmentsJson=K.cardAttachmentsJson.concat([M.jsonData])),D&&(null==(o=D.references)?void 0:o.length)&&(K.memoryReferences=D.references),x&&!K.liveThinkingStartTime&&(K.liveThinkingStartTime=new Date(K.createTime).getTime());let $=(e,t)=>{let s=e.match(/<xai:tool_usage_card_id>([^<]+)</),o=null==s?void 0:s[1];if(o){let s=K.traceSteps.findIndex(e=>"tool"===e.type&&e.text.includes("<xai:tool_usage_card_id>".concat(o,"<")));-1!==s?K.traceSteps[s]={type:"tool",text:e,rolloutId:null==t?void 0:t.toString()}:K.traceSteps.push({type:"tool",text:e,rolloutId:null==t?void 0:t.toString()})}else K.traceSteps.push({type:"tool",text:e,rolloutId:null==t?void 0:t.toString()})},X=(e,t,s)=>{var o,n,i,r;t&&(null!=(o=K.toolUsageResultById)[e]||(o[e]={}),K.toolUsageResultById={...K.toolUsageResultById,[e]:{...K.toolUsageResultById[e],webSearchResults:t}},K.webSearchResults=[...K.webSearchResults||[],...t.results||[]]),s&&(null!=(i=K.toolUsageResultById)[e]||(i[e]={}),K.toolUsageResultById={...K.toolUsageResultById,[e]:{...K.toolUsageResultById[e],xSearchResults:s}},K.xposts=[...K.xposts||[],...s.results||[]])};if("summary"===B?f&&(f.includes("xai:tool_usage_card")?$(f,Q):K.traceSteps.push({type:"summary",text:f,rolloutId:null==Q?void 0:Q.toString()})):"tool_usage_card"===B?(f&&$(f,Q),G&&X(G,S,C)):"header"===B?f&&K.traceSteps.push({type:"header",text:f,rolloutId:null==Q?void 0:Q.toString()}):"raw_function_result"===B&&G&&X(G,S,C),f)if(B&&"UNSET"!==B.toUpperCase()){if(K.searchingStartTime||(K.searchingStartTime=new Date(K.createTime).getTime()),"FINAL"===B.toUpperCase())K.searchingStartTime&&!K.searchingEndTime&&(K.searchingEndTime=Date.now()),K.message+=f;else if("tool_usage_card"===B||"summary"===B||"header"===B||"raw_function_result"===B);else if(null!=E){let e=K.steps[E];if(e)if(e.tags.includes(B)){let t=e.tags.indexOf(B);t>=0&&(e.text[t]+=f)}else e.text.push(f),e.tags.push(B)}}else x?K.thinkingTrace+=f:K.message+=f;if(K.liveThinkingStartTime&&!K.liveThinkingEndTime&&!x&&f&&(K.liveThinkingEndTime=Date.now()),_&&_.suggestions&&(K.suggestions=_.suggestions),z&&(K.followUpSuggestedMode=z,(0,r.iu)("follow_up_suggested_mode_button_shown",z.mode,{location:"response-store",responseId:K.responseId,followUpSuggestedMode:null!=(d=z.mode)?d:"UNKNOWN"})),P&&(P.followUpSuggestions&&(K.suggestions=P.followUpSuggestions),P.disclaimer&&v(P.disclaimer,K.conversationId)),T){let{imageId:t,imageUrl:s}=T;if(t&&s){let o=null!=(l=K.streamingImageById)?l:{};if(T.progress){let e="imagine"===K.imageModel?100:T.progress;K.streamingImageById={...o,[t]:{...null!=(c=o[t])?c:{},[e]:T}}}e.responseState.setOneImageIdByUrl(t,s)}}if(V&&V.message&&v(V.message,K.conversationId),A&&A.message&&v(A.message,K.conversationId),U){K.progressReport=U,K.progressReportById||(K.progressReportById={});let e=U.message;e&&(K.progressReportById[e]=U)}let J=j||(null==y?void 0:y.uiLayout);if(J&&(K.uiLayout={...null!=(u=K.uiLayout)?u:{},...J}),F&&(K.authNotification={...null!=(h=K.authNotification)?h:{},...F}),H&&(K.fastToolResponse=H),(null==y?void 0:y.steps)&&y.steps.length>0){let e=y.steps.map(e=>{var t,s,o,n,i,r,a;return{text:null!=(t=e.text)?t:[],tags:null!=(s=e.tags)?s:[],webSearchResults:null!=(o=e.webSearchResults)?o:[],xpostIds:null!=(n=e.xpostIds)?n:[],xposts:null!=(i=e.xposts)?i:[],toolUsageResults:null!=(r=e.toolUsageResults)?r:[],rolloutId:null!=(a=e.rolloutId)?a:""}}),{toolUsageResultById:t,traceSteps:s}=q(e);K.toolUsageResultById=t,K.traceSteps=s,K.steps=[...K.steps,...e]}e.streamResponseById[K.responseId]=K,e.throttledUpsertResponse(K)}function Z(e,t,s){var o,n,i,a,d,l,c;let{responseId:u,sideBySideIndex:h}=t,p=u?e.streamResponseById[u]:Object.values(e.streamResponseById)[null!=h?h:0];if(!t.isSoftStop||!p)return;let m=p.responseId;p.liveThinkingStartTime&&!p.liveThinkingEndTime&&(p.liveThinkingEndTime=Date.now()),p.generationTimeMs=Date.now()-e.startTimeMs,p.state="closed",t.responseId&&(p.responseId=t.responseId),p.partial=!1,m&&m.startsWith("streaming_in_progress_")&&m!==p.responseId&&e.responseState.removeResponse(m),(0,r.iu)("generation_time_ms",null==(o=p.generationTimeMs)?void 0:o.toString(),{location:"response-store",conversationId:e.conversation.conversationId,responseId:p.responseId}),e.forceUpsertResponse(p);let v=Object.values(e.streamResponseById).find(e=>e.experimentIds);if(v){let t=(null!=(n=null==v?void 0:v.experimentIds)?n:[]).map(t=>e.streamResponseById[t]),o=[v,...t].filter(e=>!!e);o.length>0&&o.every(e=>"closed"===e.state)&&((0,r.iu)("finished_query",null==(i=o[0])?void 0:i.responseId,{location:"response-store",conversationId:e.conversation.conversationId,experimentIds:null!=(c=null==(d=o[0])||null==(a=d.experimentIds)?void 0:a.join(","))?c:"",secondResponse:(null==(l=o[1])?void 0:l.responseId)||""}),o.forEach(e.forceUpsertResponse),e.closedStream=!0,s(o))}else(0,r.iu)("finished_query",p.responseId,{location:"response-store",conversationId:e.conversation.conversationId}),e.closedStream=!0,s([p]);t.authNotification&&(e.closedStream=!0)}function ee(e,t,s){e.savedUserResponse||(e.responseState.addUserResponse(e.conversation.conversationId,t).then(t=>(e.forceUpsertResponse(t),s(t),t)).catch(()=>{if(e.userResponse)return e.userResponse.state="error",e.forceUpsertResponse(e.userResponse),e.userResponse}).then(t=>(t&&eo(e,e=>{e.parentResponseId=t.responseId}),e.streamResponseById)).then(t=>e.streamResponseById=t).catch((0,r.HX)("response-store:ensureUserResponseSaved")),e.savedUserResponse=!0)}function et(e){var t;if(e.closedStream)return;let s=Error(S.CZ);(0,r.vV)("response-store:maybeReportStreamCloseError",s,{conversationId:e.conversation.conversationId,modelName:(null==(t=Object.values(e.streamResponseById)[0])?void 0:t.sender)||"",modelMode:e.modelMode||"none"})}function es(e,t,s){throw eo(e,t=>{t.state="error",t.liveThinkingEndTime=t.liveThinkingStartTime&&!t.liveThinkingEndTime?Date.now():t.liveThinkingEndTime,t.searchingEndTime=t.searchingStartTime&&!t.searchingEndTime?Date.now():t.searchingEndTime,e.forceUpsertResponse(t)}),s(Object.values(e.streamResponseById).flat()),t}function eo(e,t){Object.values(e.streamResponseById).forEach(e=>t(e))}},98100:(e,t,s)=>{s.d(t,{I2:()=>R,$E:()=>y,QG:()=>S,GB:()=>b});var o=s(38614),n=s(58192),i=s(12493),r=s(6132);let a=r.z.object({modelId:r.z.string(),name:r.z.string().optional(),description:r.z.string().optional(),modeDescription:r.z.string().optional(),tags:r.z.array(r.z.string()).optional(),badgeText:r.z.string().optional(),modelMode:r.z.nativeEnum(i.it).optional()});r.z.object({models:r.z.array(a).optional().default([]),defaultFreeModel:r.z.string().optional(),defaultProModel:r.z.string().optional(),unavailableModels:r.z.array(a).optional().default([]),defaultAnonModel:r.z.string().optional()});let d=e=>["get-models",e];var l=s(95158),c=s(70888),u=s(56907),h=s(61683),p=s(38541),m=s.n(p),v=s(74995),g=s(3275),I=s(88382),f=s(75500);function y(){let e=(0,f.h)();return(0,I.useMemo)(()=>e.FORCE_SIGN_IN_MODELS.value.forceSignInModels&&Array.isArray(e.FORCE_SIGN_IN_MODELS.value.forceSignInModels)?e.FORCE_SIGN_IN_MODELS.value.forceSignInModels:[],[e.FORCE_SIGN_IN_MODELS.value])}function S(e){var t,s;let n=(0,c.x)(v.A("listByConversationId")),i=(0,c.x)(v.A("attachListByConversationId")),r=(0,o.aP)(v.A("conversationId"))||"no_conversation_id",a=(0,o.aP)(v.A("reasoningMode")),d="deepsearch"==a||"deepersearch"==a,l="think"==a,u=n[r],h=i[r],p=((null==u?void 0:u.length)||0)+((null==h?void 0:h.length)||0),m=null==e||null==(t=e.tags)?void 0:t.includes("no_attachments_for_think"),g=null==e||null==(s=e.tags)?void 0:s.includes("no_attachments_for_deepsearch"),f=!!(p&&m),y=!!(p&&g);return{isAttachDisabled:(0,I.useMemo)(()=>!!m&&!!l||!!g&&!!d,[d,l,m,g]),isThinkDisabled:f,isDeepsearchDisabled:y,isThinkSelected:l,isDeepsearchSelected:d}}function b(){var e,t,s,i,r;let c=h.Ay.language,p=(0,f.h)(),{data:y,isPending:S}=(0,u.IT)({queryKey:d(c),queryFn:async()=>{var e,t,s,o,i;return{models:((e=await l.FI.modelsGetModels({body:{locale:c}})).models||[]).map(e=>a.safeParse(e)).filter(e=>e.success).map(e=>e.data).sort((e,t)=>e.name===n.Wl?-1:t.name===n.Wl||e.name===n.fG?1:t.name===n.fG?-1:0),unavailableModels:(e.unavailableModels||[]).map(e=>a.safeParse(e)).filter(e=>e.success).map(e=>e.data),defaultAnonModelId:null!=(t=e.defaultAnonModel)?t:n.Sk,defaultFreeModelId:null!=(s=e.defaultFreeModel)?s:n.Sk,defaultProModelId:null!=(o=e.defaultProModel)?o:n.Sk,defaultHeavyModelId:null!=(i=e.defaultHeavyModel)?i:n.Sk}},staleTime:3e6}),b=(0,I.useMemo)(()=>y?new Set(y.models.map(e=>e.modelId)):new Set,[y]),C=(0,I.useMemo)(()=>{var e;if(!(null==y?void 0:y.models))return[];let t=new Set(null==(e=w.safeParse(p.HIDE_MODELS.value).data)?void 0:e.hideModels),s=y.models.map(e=>({...e,...R(e.modelId,p)}));return m().sortBy(s.filter(e=>!t.has(e.modelId)&&!e.hidden),"name")},[null==y?void 0:y.models,p]),k=(0,I.useMemo)(()=>C?g.A(v.A("modelId"),C):{},[C]),_=(0,I.useMemo)(()=>g.A(e=>(0,o.He)(e.modelMode)||e.modelMode||"",(null==y?void 0:y.models)||[]),[null==y?void 0:y.models]);return{models:C,unavailableModels:null!=(e=null==y?void 0:y.unavailableModels)?e:[],defaultAnonModelId:null!=(t=null==y?void 0:y.defaultAnonModelId)?t:n.Sk,defaultFreeModelId:null!=(s=null==y?void 0:y.defaultFreeModelId)?s:n.Sk,defaultProModelId:null!=(i=null==y?void 0:y.defaultProModelId)?i:n.Sk,defaultHeavyModelId:null!=(r=null==y?void 0:y.defaultHeavyModelId)?r:n.Sk,modelById:k,modelByMode:_,isPending:S,allAccessibleModelIds:b}}function C(e,t){var s,o,n;let i={modelId:e};return(null==(s=t[e])?void 0:s.name_override)&&(i.name=t[e].name_override),(null==(o=t[e])?void 0:o.description_override)&&(i.description=t[e].description_override),(null==(n=t[e])?void 0:n.hidden)&&(i.hidden=t[e].hidden),i}function R(e,t){let s=k.safeParse(t.MODEL_CONFIG.value);return s.success?C(e,s.data):C(e,{})}let w=r.z.object({hideModels:r.z.array(r.z.string())}),k=r.z.record(r.z.string(),r.z.object({name_override:r.z.string().nullish(),description_override:r.z.string().nullish(),hidden:r.z.boolean().nullish()}).catch({})).catch({})}}]);